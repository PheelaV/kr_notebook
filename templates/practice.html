{% extends "base.html" %}

{% block title %}Practice - Hangul Learn{% endblock %}

{% block content %}
<div class="max-w-lg mx-auto" id="study-container" data-practice-mode="{{ mode }}" data-track-progress="{{ track_progress }}">
  {% if study_filters.len() > 2 %}
  <!-- Study filter dropdown (only shown when packs with lessons are enabled) -->
  <div class="mb-4 flex items-center justify-between bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2">
    <label for="practice-filter" class="text-sm text-gray-600 dark:text-gray-400 font-medium">Practice:</label>
    <select id="practice-filter"
            class="ml-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded px-2 py-1 text-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            onchange="updatePracticeFilter(this.value)">
      {% for filter in study_filters %}
      <option value="{{ filter.id }}" {% if filter.is_selected %}selected{% endif %}>{{ filter.label }}</option>
      {% endfor %}
    </select>
  </div>
  <script>
    function updatePracticeFilter(value) {
      fetch('/study/filter', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'filter=' + encodeURIComponent(value)
      }).then(() => window.location.reload());
    }
  </script>
  {% endif %}

  <div class="mb-4 text-center">
    <div class="flex items-center justify-center gap-3 mb-2">
      <span class="inline-block bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 text-sm font-medium px-3 py-1 rounded-full">
        Practice Mode
      </span>
      <!-- Mode toggle -->
      <div class="inline-flex rounded-lg border border-gray-300 dark:border-gray-600 overflow-hidden text-sm">
        <a href="/practice?mode=flip&track={{ track_progress }}"
           class="px-3 py-1 {% if mode == "flip" %}bg-indigo-600 text-white{% else %}bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700{% endif %} transition-colors">
          Flip
        </a>
        <a href="/practice?mode=interactive&track={{ track_progress }}"
           class="px-3 py-1 {% if mode == "interactive" %}bg-indigo-600 text-white{% else %}bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700{% endif %} transition-colors">
          Interactive
        </a>
      </div>
    </div>
    <!-- Track progress toggle -->
    <label class="inline-flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400 cursor-pointer mb-1">
      <input type="checkbox"
             id="track-progress-toggle"
             {% if track_progress %}checked{% endif %}
             onchange="window.location.href='/practice?mode={{ mode }}&track=' + this.checked"
             class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500">
      <span>Track progress</span>
    </label>
    <p class="text-xs text-gray-500 dark:text-gray-400">
      {% if track_progress %}
      Answers contribute to your stats
      {% else %}
      Just drilling - no stats tracking
      {% endif %}
    </p>
  </div>
  {% if mode == "interactive" %}
  {% include "interactive_card.html" %}
  {% else %}
  {% include "practice_card.html" %}
  {% endif %}
</div>

{% if mode == "flip" %}
<script>
(function() {
  // Single event listener for flip mode keyboard navigation
  function handlePracticeKeydown(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

    const cardInner = document.getElementById('card-inner');
    if (!cardInner) return;

    // Space to flip card
    if (e.code === 'Space') {
      e.preventDefault();
      cardInner.classList.toggle('flipped');
      return;
    }

    // Enter to go to next card
    if (e.code === 'Enter') {
      e.preventDefault();
      const form = document.getElementById('practice-next-form');
      if (form) {
        htmx.trigger(form, 'submit');
      }
    }
  }

  // Remove any existing listener first (in case of page re-render)
  document.removeEventListener('keydown', window._practiceKeyHandler);
  window._practiceKeyHandler = handlePracticeKeydown;
  document.addEventListener('keydown', handlePracticeKeydown);
})();
</script>
{% endif %}
{% endblock %}
