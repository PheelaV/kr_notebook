{% extends "base.html" %}

{% block title %}Progress - Hangul Learn{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
  <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
    Your Progress
  </h1>

  <div class="grid grid-cols-3 gap-2 sm:gap-4 mb-6 sm:mb-8">
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-3 sm:p-4 text-center">
      <div class="text-2xl sm:text-3xl font-bold text-indigo-600 dark:text-indigo-400">
        {{ total_cards }}{% if available_cards > total_cards %}<span class="text-lg sm:text-xl text-gray-400 dark:text-gray-500"> / {{ available_cards }}</span>{% endif %}
      </div>
      <div class="text-xs sm:text-sm text-gray-600 dark:text-gray-400">
        {% if available_cards > total_cards %}Active / Available{% else %}Active Cards{% endif %}
      </div>
    </div>
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-3 sm:p-4 text-center">
      <div class="text-2xl sm:text-3xl font-bold text-green-600 dark:text-green-400">
        {{ cards_learned }}
      </div>
      <div class="text-xs sm:text-sm text-gray-600 dark:text-gray-400">
        Cards Learned
      </div>
    </div>
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-3 sm:p-4 text-center">
      <div class="text-2xl sm:text-3xl font-bold text-blue-600 dark:text-blue-400">
        {{ total_reviews }}
      </div>
      <div class="text-xs sm:text-sm text-gray-600 dark:text-gray-400">
        Total Reviews
      </div>
    </div>
  </div>

  {% if all_tiers_unlocked %}
  <div class="bg-purple-100 dark:bg-purple-900/30 border border-purple-300 dark:border-purple-700 rounded-lg p-3 sm:p-4 mb-6">
    <div class="flex flex-wrap items-center gap-2">
      <span class="text-purple-600 dark:text-purple-400 text-xl">&#9889;</span>
      <div class="flex-1 min-w-0">
        <span class="font-semibold text-purple-800 dark:text-purple-200 text-sm sm:text-base">Accelerated Mode</span>
        <span class="hidden sm:inline text-purple-700 dark:text-purple-300 ml-2">All tiers unlocked</span>
      </div>
      <a href="/settings" class="text-sm text-purple-600 dark:text-purple-400 hover:underline whitespace-nowrap">Settings</a>
    </div>
  </div>
  {% endif %}

  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-bold text-gray-900 dark:text-white">
      Learning Tiers
    </h2>
    {% if can_unlock_next %}
    <form action="/unlock-tier" method="post">
      <button type="submit" data-testid="unlock-tier-btn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors text-sm">
        Unlock Tier {{ max_unlocked_tier + 1 }}
      </button>
    </form>
    {% endif %}
  </div>

  <div class="space-y-4">
    {% for tier in tiers %}
    <details class="bg-white dark:bg-gray-800 shadow rounded-lg {% if !tier.is_unlocked %}opacity-50{% endif %} {% if all_tiers_unlocked && tier.is_unlocked && !tier.is_enabled %}opacity-60 border-2 border-dashed border-gray-300 dark:border-gray-600{% endif %} group">
      <summary class="p-4 cursor-pointer list-none">
        <div class="flex justify-between items-center mb-2">
          <div class="font-semibold text-gray-900 dark:text-white flex items-center">
            {% if tier.is_unlocked && (tier.is_enabled || !all_tiers_unlocked) %}
            <span class="text-green-500 mr-2">&#10003;</span>
            {% else if all_tiers_unlocked && tier.is_unlocked && !tier.is_enabled %}
            <span class="text-yellow-500 mr-2">&#10007;</span>
            {% else %}
            <span class="text-gray-400 mr-2">&#128274;</span>
            {% endif %}
            Tier {{ tier.tier }}
            <span class="text-sm font-normal text-gray-500 dark:text-gray-400 ml-2">
              {% if tier.tier == 1 %}Basic Consonants & Vowels{% endif %}
              {% if tier.tier == 2 %}Y-Vowels & Special Ieung{% endif %}
              {% if tier.tier == 3 %}Aspirated & Tense Consonants{% endif %}
              {% if tier.tier == 4 %}Compound Vowels{% endif %}
            </span>
            {% if all_tiers_unlocked && tier.is_unlocked && !tier.is_enabled %}
            <span class="ml-2 text-xs bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300 px-2 py-0.5 rounded">skipped</span>
            {% endif %}
          </div>
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-600 dark:text-gray-400">
              {% if tier.is_unlocked %}
              {{ tier.learned }} / {{ tier.total }} learned
              {% else %}
              Locked
              {% endif %}
            </span>
            {% if tier.is_unlocked %}
            <iconify-icon icon="heroicons:chevron-down" class="text-gray-400 transition-transform duration-200 group-open:rotate-180" width="20" height="20"></iconify-icon>
            {% endif %}
          </div>
        </div>
        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
          {% if tier.is_unlocked %}
          <div class="{% if tier.is_enabled || !all_tiers_unlocked %}bg-indigo-600{% else %}bg-gray-400 dark:bg-gray-500{% endif %} h-3 rounded-full transition-all duration-300" style="width: {{ tier.percentage() }}%"></div>
          {% endif %}
        </div>
        {% if tier.is_unlocked && tier.is_enabled && tier.tier == max_unlocked_tier && tier.percentage() < 80 && !all_tiers_unlocked %}
        <div class="text-xs text-gray-500 dark:text-gray-400 mt-2">
          Reach 80% to unlock the next tier
        </div>
        {% endif %}
      </summary>
      {% if tier.is_unlocked %}
      <div class="px-4 pb-4 pt-2 border-t border-gray-100 dark:border-gray-700">
        <div class="grid grid-cols-4 gap-3 text-center text-sm">
          <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-2">
            <div class="text-xl font-bold text-blue-600 dark:text-blue-400">{{ tier.new_cards }}</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">New</div>
          </div>
          <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-2">
            <div class="text-xl font-bold text-yellow-600 dark:text-yellow-400">{{ tier.learning }}</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">Learning</div>
          </div>
          <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-2">
            <div class="text-xl font-bold text-green-600 dark:text-green-400">{{ tier.learned }}</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">Learned</div>
          </div>
          <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-2">
            <div class="text-xl font-bold text-purple-600 dark:text-purple-400">{{ tier.total_reviews }}</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">Reviews</div>
          </div>
        </div>

        {% if tier.has_stability_data() %}
        <!-- Memory Strength (FSRS stability) -->
        <div class="mt-4 pt-3 border-t border-gray-100 dark:border-gray-700">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Memory Strength</span>
            <span class="text-sm font-semibold {% if tier.memory_strength() >= 80 %}text-green-600 dark:text-green-400{% else if tier.memory_strength() >= 50 %}text-yellow-600 dark:text-yellow-400{% else %}text-orange-600 dark:text-orange-400{% endif %}">
              {{ tier.memory_strength() }}%
            </span>
          </div>
          <!-- Stacked bar showing strong/medium/weak distribution -->
          <div class="flex h-2 rounded-full overflow-hidden bg-gray-200 dark:bg-gray-700">
            {% let total_graduated = tier.strong_memories + tier.medium_memories + tier.weak_memories %}
            {% if total_graduated > 0 %}
            <div class="bg-green-500" style="width: {{ (tier.strong_memories * 100) / total_graduated }}%"></div>
            <div class="bg-yellow-500" style="width: {{ (tier.medium_memories * 100) / total_graduated }}%"></div>
            <div class="bg-orange-500" style="width: {{ (tier.weak_memories * 100) / total_graduated }}%"></div>
            {% endif %}
          </div>
          <div class="flex justify-between mt-2 text-xs text-gray-500 dark:text-gray-400">
            <span class="flex items-center gap-1">
              <span class="w-2 h-2 rounded-full bg-green-500"></span>
              Strong ({{ tier.strong_memories }})
            </span>
            <span class="flex items-center gap-1">
              <span class="w-2 h-2 rounded-full bg-yellow-500"></span>
              Medium ({{ tier.medium_memories }})
            </span>
            <span class="flex items-center gap-1">
              <span class="w-2 h-2 rounded-full bg-orange-500"></span>
              Weak ({{ tier.weak_memories }})
            </span>
          </div>
          <p class="text-xs text-gray-400 dark:text-gray-500 mt-2">
            Based on FSRS stability: Strong &ge;14d, Medium 7-14d, Weak &lt;7d
          </p>
        </div>
        {% endif %}

        <p class="text-xs text-gray-500 dark:text-gray-400 mt-3">
          <span class="font-medium">New:</span> Never reviewed &bull;
          <span class="font-medium">Learning:</span> In learning phase &bull;
          <span class="font-medium">Learned:</span> Graduated to FSRS
        </p>
      </div>
      {% endif %}
    </details>
    {% endfor %}
  </div>

  <!-- Vocabulary Pack Progress Sections -->
  {% for unit in units %}
    {% match unit %}
      {% when ProgressUnit::VocabularyPack with (pack) %}
      <div class="mt-8">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-gray-900 dark:text-white">
            {{ pack.display_name }}
          </h2>
          {% if pack.is_accelerated %}
          <span class="text-xs bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 px-2 py-1 rounded">
            All {{ pack.unit_name }} Unlocked
          </span>
          {% endif %}
        </div>

        <div class="space-y-3">
          {% for lesson in pack.lessons %}
          <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4 {% if !lesson.is_unlocked %}opacity-50{% endif %}">
            <div class="flex justify-between items-center mb-2">
              <div class="font-semibold text-gray-900 dark:text-white flex items-center">
                {% if lesson.is_unlocked %}
                <span class="text-green-500 mr-2">&#10003;</span>
                {% else %}
                <span class="text-gray-400 mr-2">&#128274;</span>
                {% endif %}
                {{ pack.section_prefix }} {{ lesson.lesson }}
                {% if let Some(label) = lesson.label %}
                <span class="text-sm font-normal text-gray-500 dark:text-gray-400 ml-2">{{ label }}</span>
                {% endif %}
              </div>
              <span class="text-sm text-gray-600 dark:text-gray-400">
                {% if lesson.is_unlocked %}
                {{ lesson.learned }} / {{ lesson.total }} learned
                {% else %}
                Locked
                {% endif %}
              </span>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
              {% if lesson.is_unlocked %}
              <div class="bg-indigo-600 h-2 rounded-full transition-all duration-300" style="width: {{ lesson.percentage }}%"></div>
              {% endif %}
            </div>
            {% if lesson.is_unlocked %}
            <div class="flex justify-between mt-2 text-xs text-gray-500 dark:text-gray-400">
              <span>New: {{ lesson.new_cards }}</span>
              <span>Learning: {{ lesson.learning }}</span>
              <span>Learned: {{ lesson.learned }}</span>
            </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>

        <div class="mt-3 text-sm text-gray-500 dark:text-gray-400">
          Overall: {{ pack.total_learned }} / {{ pack.total_cards }} cards learned
        </div>
      </div>
      {% when ProgressUnit::HangulTiers with { .. } %}
      {# Hangul tiers are rendered above, skip here #}
    {% endmatch %}
  {% endfor %}

  {% if !character_stats_groups.is_empty() %}
  <div class="mt-8">
    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
      Character Performance
    </h2>
    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
      Your accuracy for each character over different time windows.
    </p>

    {% for group in character_stats_groups %}
    <div class="mb-6">
      <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-3">
        {{ group.type_label }}
      </h3>
      <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
        <table class="w-full text-sm">
          <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
              <th class="px-3 py-2 text-left text-gray-600 dark:text-gray-300 font-medium">Char</th>
              <th class="px-3 py-2 text-center text-gray-600 dark:text-gray-300 font-medium">All Time</th>
              <th class="px-3 py-2 text-center text-gray-600 dark:text-gray-300 font-medium">7 Day</th>
              <th class="px-3 py-2 text-center text-gray-600 dark:text-gray-300 font-medium">24 Hour</th>
              <th class="px-3 py-2 text-right text-gray-600 dark:text-gray-300 font-medium">Status</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
            {% for stat in group.stats %}
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
              <td class="px-3 py-2 text-2xl font-bold text-gray-900 dark:text-white">{{ stat.character }}</td>
              <td class="px-3 py-2 text-center">
                {% if stat.lifetime_pct > 0 %}
                <span class="{% if stat.lifetime_pct >= 90 %}text-green-600 dark:text-green-400{% else if stat.lifetime_pct >= 70 %}text-yellow-600 dark:text-yellow-400{% else %}text-red-600 dark:text-red-400{% endif %}">
                  {{ stat.lifetime_pct }}%
                </span>
                {% else %}
                <span class="text-gray-400">—</span>
                {% endif %}
              </td>
              <td class="px-3 py-2 text-center">
                {% if stat.rate_7d_pct > 0 %}
                <span class="{% if stat.rate_7d_pct >= 90 %}text-green-600 dark:text-green-400{% else if stat.rate_7d_pct >= 70 %}text-yellow-600 dark:text-yellow-400{% else %}text-red-600 dark:text-red-400{% endif %}">
                  {{ stat.rate_7d_pct }}%
                </span>
                {% else %}
                <span class="text-gray-400">—</span>
                {% endif %}
              </td>
              <td class="px-3 py-2 text-center">
                {% if stat.attempts_1d > 0 %}
                <span class="{% if stat.rate_1d_pct >= 90 %}text-green-600 dark:text-green-400{% else if stat.rate_1d_pct >= 70 %}text-yellow-600 dark:text-yellow-400{% else %}text-red-600 dark:text-red-400{% endif %}">
                  {{ stat.rate_1d_pct }}%
                </span>
                {% else %}
                <span class="text-gray-400">—</span>
                {% endif %}
              </td>
              <td class="px-3 py-2 text-right">
                <span class="{{ stat.status_color }} font-medium">{{ stat.status }}</span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  {% if !problem_cards.is_empty() %}
  <div class="mt-8">
    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
      Problem Areas
    </h2>
    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
      Characters you often get wrong. Focus on these for improvement!
    </p>
    <div class="space-y-3">
      {% for card in problem_cards %}
      <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4">
            <span class="text-3xl font-bold text-gray-900 dark:text-white">{{ card.front }}</span>
            <div>
              <span class="text-sm text-red-500 dark:text-red-400">
                {{ card.confusion_count }} mistake{% if card.confusion_count != 1 %}s{% endif %}
              </span>
              {% if !card.top_wrong_answers.is_empty() %}
              <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                Common wrong answers:
                {% for answer in card.top_wrong_answers %}
                <span class="inline-block bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded mx-0.5">{{ answer }}</span>
                {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>
          <span class="text-red-500 dark:text-red-400">
            <iconify-icon icon="heroicons:exclamation-triangle" width="24" height="24"></iconify-icon>
          </span>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <div class="mt-8 text-center">
    <a href="/study" class="inline-block bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
      Continue Studying
    </a>
  </div>
</div>
{% endblock %}
