<div id="card-container" class="text-center">
  <div class="mb-2 flex items-center justify-center gap-2">
    <span class="text-sm text-gray-500 dark:text-gray-400">Tier {{ tier }}</span>
  </div>

  <!-- Card Front Display -->
  <div class="mb-4 sm:mb-6 bg-white dark:bg-gray-800 shadow-lg rounded-xl p-6 sm:p-10">
    {% if front.starts_with("Which letter sounds like") %}
    <!-- Question-style card: split into label + prominent answer -->
    <div class="text-base sm:text-lg text-gray-500 dark:text-gray-400 mb-2">
      Which letter sounds like
    </div>
    <div class="text-5xl sm:text-7xl font-bold text-gray-900 dark:text-white mb-4">
      {{ front.trim_start_matches("Which letter sounds like '").trim_end_matches("'?") }}
    </div>
    {% else %}
    <!-- Regular card: single Korean character -->
    <div class="text-5xl sm:text-7xl font-bold text-gray-900 dark:text-white mb-4">
      {{ front }}
    </div>
    {% endif %}

    {% if !validated %}
    <!-- Answer Input Phase -->
    <div id="input-phase">
      {% if is_multiple_choice %}
      <!-- Multiple Choice Mode (for Korean answers) -->
      <form id="answer-form" hx-post="/practice-validate" hx-target="#card-container" hx-swap="outerHTML"
            onsubmit="return validateMultipleChoice()">
        <input type="hidden" name="card_id" value="{{ card_id }}">
        <input type="hidden" name="track_progress" value="{{ track_progress }}">
        <input type="hidden" name="answer" id="answer-input" value="">

        <div class="grid grid-cols-2 gap-2 sm:gap-3 mb-4">
          {% for choice in choices %}
          <button type="button"
                  id="choice-{{ loop.index }}"
                  data-choice="{{ choice }}"
                  onclick="selectAnswer(this, '{{ choice }}')"
                  class="choice-btn relative text-3xl sm:text-4xl p-4 sm:p-6 min-h-[4rem] sm:min-h-[5rem] bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 active:bg-indigo-200 dark:active:bg-indigo-800 text-gray-900 dark:text-white font-bold rounded-lg transition-colors border-2 border-transparent touch-manipulation">
            <span class="absolute top-1 left-2 text-xs font-normal text-gray-400 dark:text-gray-500">{{ loop.index }}</span>
            {{ choice }}
          </button>
          {% endfor %}
        </div>

        <button type="submit" id="submit-btn" disabled
                class="w-full bg-indigo-500 hover:bg-indigo-600 disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-semibold py-3 px-4 rounded-lg transition-colors">
          Check <span class="text-xs opacity-75">(Enter)</span>
        </button>
      </form>

      <script>
        let selectedAnswer = null;

        function validateMultipleChoice() {
          if (!selectedAnswer || !document.getElementById('answer-input').value) {
            return false;
          }
          return true;
        }

        function selectAnswer(btn, answer) {
          document.querySelectorAll('.choice-btn').forEach(b => {
            b.classList.remove('border-indigo-500', 'bg-indigo-100', 'dark:bg-indigo-900', 'selected');
            b.classList.add('border-transparent');
          });

          btn.classList.remove('border-transparent');
          btn.classList.add('border-indigo-500', 'bg-indigo-100', 'dark:bg-indigo-900', 'selected');

          document.getElementById('answer-input').value = answer;
          selectedAnswer = answer;
          document.getElementById('submit-btn').disabled = false;
        }

        document.addEventListener('keydown', function(e) {
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

          const keyMap = {'Digit1': 1, 'Digit2': 2, 'Digit3': 3, 'Digit4': 4,
                          'Numpad1': 1, 'Numpad2': 2, 'Numpad3': 3, 'Numpad4': 4};
          if (keyMap[e.code]) {
            e.preventDefault();
            const btn = document.getElementById('choice-' + keyMap[e.code]);
            if (btn) {
              selectAnswer(btn, btn.dataset.choice);
            }
            return;
          }

          if (e.code === 'Enter') {
            e.preventDefault();
            if (selectedAnswer) {
              document.getElementById('answer-form').requestSubmit();
            }
          }
        });
      </script>
      {% else %}
      <!-- Text Input Mode (for romanization answers) -->
      <form id="answer-form" hx-post="/practice-validate" hx-target="#card-container" hx-swap="outerHTML">
        <input type="hidden" name="card_id" value="{{ card_id }}">
        <input type="hidden" name="track_progress" value="{{ track_progress }}">

        <div class="mb-4">
          <input type="text"
                 name="answer"
                 id="answer-input"
                 placeholder="Type your answer..."
                 autocomplete="off"
                 autofocus
                 class="w-full p-3 text-lg text-center border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 dark:focus:border-indigo-400 focus:outline-none bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
        </div>

        <button type="submit"
                class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
          Check
        </button>
      </form>

      <script>
        document.getElementById('answer-input')?.focus();
      </script>
      {% endif %}
    </div>
    {% endif %}

    {% if validated %}
    <!-- Result Phase -->
    <div id="result-phase">
      <div class="mb-4">
        {% if is_correct %}
        <div class="flex items-center justify-center gap-2 text-green-600 dark:text-green-400 mb-2">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          <span class="text-2xl font-bold">Correct!</span>
        </div>
        {% else %}
        <div class="flex items-center justify-center gap-2 text-red-600 dark:text-red-400 mb-2">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          <span class="text-2xl font-bold">Incorrect</span>
        </div>
        {% endif %}

        <div class="text-xl text-gray-600 dark:text-gray-300 mb-2">
          {% if !is_correct %}
          <span class="text-gray-500 dark:text-gray-400">You answered: </span>
          <span class="text-red-500 {% if is_multiple_choice %}text-4xl{% endif %}">{{ user_answer }}</span>
          <br>
          {% endif %}
          <span class="text-gray-500 dark:text-gray-400">Correct answer: </span>
          <span class="text-indigo-600 dark:text-indigo-400 font-semibold {% if is_multiple_choice %}text-4xl{% endif %}">{{ main_answer }}</span>
        </div>

        {% if let Some(desc) = description %}
        <div class="text-base text-gray-500 dark:text-gray-400">
          {{ desc }}
        </div>
        {% endif %}
      </div>

      <div class="flex gap-2 sm:gap-3">
        <a href="/study" class="flex-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-900 dark:text-white font-semibold py-3 px-4 rounded-lg transition-colors text-center">
          Back to Study
        </a>
        <form id="practice-next-form" hx-post="/practice-next?mode=interactive" hx-target="#card-container" hx-swap="outerHTML" class="flex-1">
          <input type="hidden" name="card_id" value="{{ card_id }}">
          <input type="hidden" name="track_progress" value="{{ track_progress }}">
          <button type="submit"
                  class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
            Next <span class="text-sm opacity-75">(Enter)</span>
          </button>
        </form>
      </div>

      <script>
        document.addEventListener('keydown', function(e) {
          if (e.code === 'Enter' && e.target.tagName !== 'INPUT') {
            e.preventDefault();
            const form = document.getElementById('practice-next-form');
            if (form) {
              htmx.trigger(form, 'submit');
            }
          }
        });
      </script>
    </div>
    {% endif %}
  </div>
</div>
