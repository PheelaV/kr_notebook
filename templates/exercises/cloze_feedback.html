{# Cloze Feedback Component
   Displays the result after submitting a cloze answer.
   Follows patterns from card_result.html for consistency.

   Required context variables:
   - correct: bool - Whether the answer was correct
   - feedback: Option<String> - Feedback message
   - expected: String - The correct answer
   - user_answer: String - The user's submitted answer
   - english: Option<String> - English translation
   - pack_id: String
   - lesson: u8
   - exercise_index: usize
   - exercise_count: usize
#}
<div id="card-container" data-testid="card-container" class="text-center">
  <div class="mb-4 sm:mb-6 bg-white dark:bg-gray-800 shadow-lg rounded-xl p-6 sm:p-10">
    <!-- Result Phase -->
    <div id="result-phase" data-testid="result-phase">
      <div class="mb-4">
        {% if correct %}
        <div data-result="correct" data-testid="result-correct" class="flex items-center justify-center gap-2 text-green-600 dark:text-green-400 mb-2">
          <iconify-icon icon="heroicons:check" width="32" height="32"></iconify-icon>
          <span class="text-2xl font-bold">Correct!</span>
        </div>
        {% else %}
        <div data-result="incorrect" data-testid="result-incorrect" class="flex items-center justify-center gap-2 text-red-600 dark:text-red-400 mb-2">
          <iconify-icon icon="heroicons:x-mark" width="32" height="32"></iconify-icon>
          <span class="text-2xl font-bold">Incorrect</span>
        </div>
        {% endif %}

        <!-- Show feedback message if any -->
        {% if let Some(msg) = feedback %}
        <div class="text-sm text-gray-600 dark:text-gray-400 mb-3">{{ msg }}</div>
        {% endif %}

        <div class="text-xl text-gray-600 dark:text-gray-300 mb-2">
          {% if !correct %}
          <span class="text-gray-500 dark:text-gray-400">You answered: </span>
          <span data-user-answer data-testid="user-answer" class="text-red-500 text-4xl">{{ user_answer }}</span>
          <br>
          {% endif %}
          <span class="text-gray-500 dark:text-gray-400">Correct answer: </span>
          <span data-correct-answer data-testid="correct-answer" class="text-indigo-600 dark:text-indigo-400 font-semibold text-4xl">{{ expected }}</span>
        </div>

        <!-- English translation -->
        {% if let Some(eng) = english %}
        <div data-description class="text-base text-gray-500 dark:text-gray-400 mt-4">
          {{ eng }}
        </div>
        {% endif %}
      </div>

      <!-- Next button -->
      <form id="next-exercise-form" hx-post="/exercises/next" hx-target="#exercise-container" hx-swap="innerHTML">
        <input type="hidden" name="pack_id" value="{{ pack_id }}">
        <input type="hidden" name="lesson" value="{{ lesson }}">
        <input type="hidden" name="exercise_index" value="{{ exercise_index }}">
        <button type="submit"
                data-testid="next-exercise"
                class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors text-lg">
          {% if exercise_index + 1 >= exercise_count %}
          Complete Lesson <span class="text-sm opacity-75">(Enter)</span>
          {% else %}
          Next Exercise <span class="text-sm opacity-75">(Enter)</span>
          {% endif %}
        </button>
      </form>
    </div>
  </div>
</div>

<!-- OOB swap for progress bar -->
<div id="exercise-progress" hx-swap-oob="true" data-testid="progress-bar" class="mb-4 flex items-center justify-center gap-3 text-xs text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2">
  <span class="flex items-center gap-1">
    <span class="text-indigo-500 dark:text-indigo-400">&#9679;</span>
    Progress: {{ exercise_index + 1 }} / {{ exercise_count }}
  </span>
  <span class="flex-1">
    <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
      <div class="bg-green-500 h-2 rounded-full transition-all duration-300" style="width: {{ (exercise_index + 1) * 100 / exercise_count }}%"></div>
    </div>
  </span>
</div>

<script>
  // Auto-focus next button and handle Enter key
  document.addEventListener('DOMContentLoaded', function() {
    const nextBtn = document.querySelector('[data-testid="next-exercise"]');
    if (nextBtn) nextBtn.focus();
  });

  // Listen for Enter key to submit next form
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      const nextBtn = document.querySelector('[data-testid="next-exercise"]');
      if (nextBtn) {
        e.preventDefault();
        nextBtn.click();
      }
    }
  });
</script>
