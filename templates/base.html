<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Hangul Learn{% endblock %}</title>
  <script>
    // Apply dark mode immediately to prevent flash
    if (localStorage.getItem('darkMode') === 'true' ||
        (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark');
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/htmx.org@2.0.4"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
    }

    // Dark mode toggle function
    function toggleDarkMode() {
      const html = document.documentElement;
      const isDark = html.classList.toggle('dark');
      localStorage.setItem('darkMode', isDark);
      return isDark;
    }

    // Get current dark mode state
    function isDarkMode() {
      return document.documentElement.classList.contains('dark');
    }
  </script>
  <style>
    .card-flip {
      perspective: 1000px;
    }
    .card-inner {
      transform-style: preserve-3d;
      transition: transform 0.3s;
    }
    .card-inner.flipped {
      transform: rotateY(180deg);
    }
    .card-front, .card-back {
      backface-visibility: hidden;
    }
    .card-back {
      transform: rotateY(180deg);
    }

    /* Card loading state - fade out during htmx swap */
    .card-inner.card-loading .card-front,
    .card-inner.card-loading .card-back {
      opacity: 0;
    }
    .card-front, .card-back {
      transition: opacity 0.15s ease-out;
    }

    /* Haetae Mascot Animations */
    @keyframes haetae-float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }

    @keyframes haetae-blink {
      0%, 94%, 100% { transform: scaleY(1); }
      96%, 98% { transform: scaleY(0.1); }
    }

    @keyframes haetae-tail-wag {
      0%, 100% { transform: rotate(-10deg); }
      50% { transform: rotate(10deg); }
    }

    @keyframes haetae-tail-wag-fast {
      0%, 100% { transform: rotate(-15deg); }
      50% { transform: rotate(15deg); }
    }

    @keyframes haetae-bounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* Firework animations */
    @keyframes firework-burst {
      0% { transform: translate(0, 0) scale(0); opacity: 1; }
      100% { transform: translate(var(--tx), var(--ty)) scale(1); opacity: 0; }
    }

    @keyframes firework-sparkle {
      0%, 100% { opacity: 0; transform: scale(0); }
      50% { opacity: 1; transform: scale(1); }
    }

    .haetae-wrapper {
      position: relative;
    }

    .haetae-container {
      animation: haetae-float 3s ease-in-out infinite;
      transition: filter 0.3s ease;
    }

    .haetae-container:hover {
      filter: brightness(1.05);
    }

    .haetae-eye {
      transform-origin: center;
      animation: haetae-blink 4s ease-in-out infinite;
    }

    .haetae-eye-right {
      animation-delay: 0.1s;
    }

    .haetae-tail {
      transform-origin: 85% 50%;
      animation: haetae-tail-wag 0.6s ease-in-out infinite;
    }

    /* Emotion states */
    .haetae-container.happy .haetae-mouth-happy { display: block; }
    .haetae-container.happy .haetae-mouth-neutral { display: none; }
    .haetae-container.happy .haetae-tail { animation: haetae-tail-wag-fast 0.3s ease-in-out infinite; }
    .haetae-container:not(.happy) .haetae-mouth-happy { display: none; }
    .haetae-container:not(.happy) .haetae-mouth-neutral { display: block; }

    /* Firework particles */
    .firework-particle {
      position: absolute;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      pointer-events: none;
      animation: firework-burst 0.8s ease-out forwards;
    }

    /* Tooltip */
    .haetae-tooltip {
      position: absolute;
      bottom: 100%;
      right: 0;
      margin-bottom: 8px;
      padding: 8px 12px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      font-size: 12px;
      color: #4B5563;
      white-space: nowrap;
      opacity: 0;
      transform: translateY(4px);
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: none;
    }

    .haetae-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      right: 20px;
      border: 6px solid transparent;
      border-top-color: white;
    }

    .dark .haetae-tooltip {
      background: #374151;
      color: #E5E7EB;
    }

    .dark .haetae-tooltip::after {
      border-top-color: #374151;
    }

    .haetae-wrapper:hover .haetae-tooltip {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body class="h-full bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
  <div class="min-h-full">
    <nav class="bg-white dark:bg-gray-800 shadow-sm">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="flex h-16 justify-between items-center">
          <!-- Logo -->
          <div class="flex items-center gap-2">
            <a href="/" class="flex items-center gap-2 text-xl font-bold text-indigo-600 dark:text-indigo-400">
              <svg class="w-7 h-7" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="24" cy="14" r="8" stroke="currentColor" stroke-width="3" fill="none"/>
                <path d="M10 28 L38 28" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                <path d="M14 38 L34 38" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
              </svg>
              <span class="hidden sm:inline">Hangul Learn</span>
              <span class="sm:hidden">Hangul</span>
            </a>
          </div>

          <!-- Desktop Navigation -->
          <div class="hidden md:flex items-center space-x-1">
            <a href="/" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium">
              Home
            </a>
            <a href="/study" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium">
              Study
            </a>
            <a href="/progress" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium">
              Progress
            </a>
            <a href="/reference" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium">
              Reference
            </a>
            <a href="/pronunciation" id="nav-pronunciation" class="hidden text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium">
              Pronunciation
            </a>
            <a href="/library" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium">
              Library
            </a>
            <a href="/guide" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium">
              Guide
            </a>
            <a href="/settings" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium">
              Settings
            </a>
          </div>

          <!-- Mobile menu button -->
          <div class="md:hidden flex items-center">
            <button type="button" onclick="toggleMobileMenu()" class="inline-flex items-center justify-center p-2 rounded-md text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none" aria-expanded="false">
              <span class="sr-only">Open main menu</span>
              <!-- Hamburger icon -->
              <svg id="menu-icon-closed" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
              </svg>
              <!-- X icon (hidden by default) -->
              <svg id="menu-icon-open" class="hidden h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Mobile menu (hidden by default) -->
      <div id="mobile-menu" class="hidden md:hidden border-t border-gray-200 dark:border-gray-700">
        <div class="px-2 pt-2 pb-3 space-y-1">
          <a href="/" class="block text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-base font-medium">
            Home
          </a>
          <a href="/study" class="block text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-base font-medium">
            Study
          </a>
          <a href="/progress" class="block text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-base font-medium">
            Progress
          </a>
          <a href="/reference" class="block text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-base font-medium">
            Reference
          </a>
          <a href="/pronunciation" id="nav-pronunciation-mobile" class="hidden text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-base font-medium">
            Pronunciation
          </a>
          <a href="/library" class="block text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-base font-medium">
            Library
          </a>
          <a href="/guide" class="block text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-base font-medium">
            Guide
          </a>
          <a href="/settings" class="block text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-base font-medium">
            Settings
          </a>
        </div>
      </div>
    </nav>

    <main class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
      {% block content %}{% endblock %}
    </main>
  </div>

  <script>
    // Mobile menu toggle
    function toggleMobileMenu() {
      const menu = document.getElementById('mobile-menu');
      const iconClosed = document.getElementById('menu-icon-closed');
      const iconOpen = document.getElementById('menu-icon-open');

      menu.classList.toggle('hidden');
      iconClosed.classList.toggle('hidden');
      iconOpen.classList.toggle('hidden');
    }

    // Check if pronunciation content exists and show/hide nav links
    (function() {
      fetch('/audio/scraped/htsk/lesson1/manifest.json', { method: 'HEAD' })
        .then(function(response) {
          if (response.ok) {
            var navLink = document.getElementById('nav-pronunciation');
            var navLinkMobile = document.getElementById('nav-pronunciation-mobile');
            if (navLink) navLink.classList.remove('hidden');
            if (navLinkMobile) navLinkMobile.classList.remove('hidden');
          }
        })
        .catch(function() {
          // Content not available, keep links hidden
        });
    })();
  </script>

  <!-- Baby Haetae Mascot (hidden on small screens, smaller on medium) -->
  {% block mascot %}
  <div id="haetae-wrapper" class="hidden sm:block fixed bottom-4 right-4 haetae-wrapper sm:scale-75 md:scale-100 origin-bottom-right">
    <!-- Tooltip -->
    <div class="haetae-tooltip">
      Your guardian companion on the path to mastery
    </div>

    <!-- Firework container -->
    <div id="haetae-fireworks" class="absolute inset-0 pointer-events-none overflow-visible"></div>

    <div id="haetae-mascot" class="haetae-container cursor-pointer" style="width: 80px; height: 80px;">
      {% include "partials/haetae_mascot.html" %}
    </div>
  </div>
  {% endblock mascot %}

  <script>
    // Haetae interaction
    (function() {
      const haetae = document.getElementById('haetae-mascot');
      const fireworksContainer = document.getElementById('haetae-fireworks');
      if (!haetae || !fireworksContainer) return;

      // Traditional Korean colors for fireworks (dancheong palette)
      const fireworkColors = [
        '#C1403D', // Red (Dancheong red)
        '#2E8B8B', // Teal (Jade)
        '#E5C158', // Gold
        '#3D5A80', // Blue
        '#81B29A', // Green
        '#F4A261', // Orange
      ];

      function createFirework() {
        const particleCount = 12;
        const centerX = 40;
        const centerY = 40;

        for (let i = 0; i < particleCount; i++) {
          const particle = document.createElement('div');
          particle.className = 'firework-particle';

          // Calculate direction
          const angle = (i / particleCount) * Math.PI * 2;
          const distance = 40 + Math.random() * 30;
          const tx = Math.cos(angle) * distance;
          const ty = Math.sin(angle) * distance;

          // Random color from palette
          const color = fireworkColors[Math.floor(Math.random() * fireworkColors.length)];

          particle.style.cssText = `
            left: ${centerX}px;
            top: ${centerY}px;
            background: ${color};
            --tx: ${tx}px;
            --ty: ${ty}px;
            animation-delay: ${Math.random() * 0.1}s;
          `;

          fireworksContainer.appendChild(particle);

          // Remove particle after animation
          setTimeout(() => particle.remove(), 900);
        }

        // Add some sparkle stars
        for (let i = 0; i < 6; i++) {
          const star = document.createElement('div');
          const angle = Math.random() * Math.PI * 2;
          const distance = 20 + Math.random() * 50;

          star.className = 'firework-particle';
          star.style.cssText = `
            left: ${centerX}px;
            top: ${centerY}px;
            width: 4px;
            height: 4px;
            background: #FFFFFF;
            box-shadow: 0 0 4px #FFFFFF;
            --tx: ${Math.cos(angle) * distance}px;
            --ty: ${Math.sin(angle) * distance}px;
            animation-delay: ${0.1 + Math.random() * 0.2}s;
          `;

          fireworksContainer.appendChild(star);
          setTimeout(() => star.remove(), 1000);
        }
      }

      haetae.addEventListener('click', function() {
        const wasHappy = this.classList.contains('happy');
        this.classList.toggle('happy');

        // Fireworks when becoming happy
        if (!wasHappy) {
          createFirework();
          // Second burst slightly delayed
          setTimeout(createFirework, 150);
        }
      });
    })();
  </script>

  <script>
    // Coordinate card flip animation with htmx swaps
    (function() {
      // Before request: unflip card and fade out content
      document.body.addEventListener('htmx:beforeRequest', function(evt) {
        const cardInner = document.querySelector('#card-inner');
        if (!cardInner) return;

        // Unflip if flipped
        if (cardInner.classList.contains('flipped')) {
          cardInner.classList.remove('flipped');
        }
        // Fade out content during transition
        cardInner.classList.add('card-loading');
      });

      // After swap: ensure clean state and fade in
      document.body.addEventListener('htmx:afterSwap', function(evt) {
        const cardInner = document.querySelector('#card-inner');
        if (!cardInner) return;

        // Ensure fresh state
        requestAnimationFrame(function() {
          cardInner.classList.remove('card-loading');
          cardInner.classList.remove('flipped');
        });
      });
    })();
  </script>
</body>
</html>
