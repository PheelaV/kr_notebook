<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Hangul Learn{% endblock %}</title>
  <!-- Favicon bundle -->
  <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
  <link rel="manifest" href="/static/site.webmanifest">
  <meta name="theme-color" content="#4F46E5">
  <script>
    // Apply dark mode immediately to prevent flash
    if (localStorage.getItem('darkMode') === 'true' ||
        (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark');
    }
  </script>
  <link rel="stylesheet" href="{{ "/static/css/styles.css"|asset_url }}">
  <script src="https://unpkg.com/htmx.org@2.0.4/dist/htmx.min.js"
          integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+"
          crossorigin="anonymous"></script>
  <script src="https://code.iconify.design/iconify-icon/2.1.0/iconify-icon.min.js"
          integrity="sha384-GPb5RlngihS9H0z1D137JsvzmeZ7tCpWEF4t5YDoTZyMsPP8S7h7vFDh4XhheU83"
          crossorigin="anonymous"></script>
  <script src="{{ "/static/js/card-interactions.js"|asset_url }}"></script>
  <script src="{{ "/static/js/sw-register.js"|asset_url }}"></script>
  <script src="{{ "/static/js/offline-detect.js"|asset_url }}"></script>
  <script src="{{ "/static/js/offline-storage.js"|asset_url }}"></script>
  <script src="{{ "/static/js/offline-sync.js"|asset_url }}"></script>
  <script>
    // Dark mode toggle function
    function toggleDarkMode() {
      const html = document.documentElement;
      const isDark = html.classList.toggle('dark');
      localStorage.setItem('darkMode', isDark);
      return isDark;
    }

    // Get current dark mode state
    function isDarkMode() {
      return document.documentElement.classList.contains('dark');
    }
  </script>
</head>
<body class="h-full bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
  <div class="min-h-full">
    <nav class="relative bg-white dark:bg-gray-800 shadow-sm">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="flex h-16 justify-between items-center">
          <!-- Logo -->
          <div class="flex items-center gap-2">
            <a href="/" class="flex items-center gap-2 text-xl font-bold text-indigo-600 dark:text-indigo-400">
              <svg class="w-7 h-7" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="24" cy="14" r="8" stroke="currentColor" stroke-width="3" fill="none"/>
                <path d="M10 28 L38 28" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                <path d="M14 38 L34 38" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
              </svg>
              <span class="hidden sm:inline">Hangul Learn</span>
              <span class="sm:hidden">Hangul</span>
            </a>
          </div>

          <!-- Desktop Navigation -->
          <div class="hidden md:flex items-center space-x-1">
            <a href="/" class="inline-flex items-center text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md" title="Home">
              <iconify-icon icon="heroicons:home" width="20" height="20"></iconify-icon>
            </a>
            <a href="/study" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium">
              Study
            </a>
            <a href="/progress" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium">
              Progress
            </a>
            {% if nav.has_grammar_access %}
            <a href="/exercises" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium">
              Exercises
            </a>
            {% endif %}
            <!-- Reference link/dropdown - show dropdown if user has grammar access -->
            {% if nav.has_grammar_access %}
            <div class="relative group">
              <a href="/reference" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium inline-flex items-center gap-1">
                Reference
                <iconify-icon icon="heroicons:chevron-down" width="14" height="14" class="transition-transform group-hover:rotate-180"></iconify-icon>
              </a>
              <div class="absolute left-0 top-full pt-1 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-150 z-50">
                <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg border border-gray-200 dark:border-gray-700 py-1 min-w-[180px]">
                  <a href="/reference/basics" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    Hangul Basics
                  </a>
                  <a href="/reference/pack/krnb_htsk_voc1_pack" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    Grammar Lessons
                  </a>
                </div>
              </div>
            </div>
            {% else %}
            <a href="/reference" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium">
              Reference
            </a>
            {% endif %}
            <a href="/pronunciation" id="nav-pronunciation" class="hidden text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium">
              Pronunciation
            </a>
            <a href="/listen" id="nav-listen" class="hidden text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium">
              Listen
            </a>
            <!-- Library link/dropdown - show dropdown if user has vocab access -->
            {% if nav.has_vocab_access %}
            <div class="relative group">
              <a href="/library" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium inline-flex items-center gap-1">
                Library
                <iconify-icon icon="heroicons:chevron-down" width="14" height="14" class="transition-transform group-hover:rotate-180"></iconify-icon>
              </a>
              <div class="absolute left-0 top-full pt-1 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-150 z-50">
                <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg border border-gray-200 dark:border-gray-700 py-1 min-w-[180px]">
                  <a href="/library/characters" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    Characters
                  </a>
                  <a href="/library/vocabulary" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    Vocabulary
                  </a>
                </div>
              </div>
            </div>
            {% else %}
            <a href="/library" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium">
              Library
            </a>
            {% endif %}
            <a href="/guide" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium">
              Guide
            </a>
            <div class="h-5 w-px bg-gray-300 dark:bg-gray-600 mx-2"></div>
            <div class="flex items-center">
              <span id="nav-username" class="text-gray-500 dark:text-gray-400 text-sm px-3 py-2"></span>
              <a href="/settings" data-testid="nav-settings" class="inline-flex items-center text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md" title="Settings">
                <iconify-icon icon="heroicons:cog-6-tooth" width="20" height="20"></iconify-icon>
              </a>
              <form action="/logout" method="POST" class="inline-flex items-center">
                <button type="submit" data-testid="logout-btn" class="inline-flex items-center text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md" title="Logout">
                  <iconify-icon icon="heroicons:arrow-right-start-on-rectangle" width="20" height="20"></iconify-icon>
                </button>
              </form>
            </div>
          </div>

          <!-- Mobile menu button -->
          <div class="md:hidden flex items-center">
            <button type="button" onclick="toggleMobileMenu(event)" class="inline-flex items-center justify-center p-2 rounded-md text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none" aria-expanded="false">
              <span class="sr-only">Open main menu</span>
              <!-- Hamburger icon -->
              <iconify-icon id="menu-icon-closed" icon="heroicons:bars-3" width="24" height="24"></iconify-icon>
              <!-- X icon (hidden by default) -->
              <iconify-icon id="menu-icon-open" icon="heroicons:x-mark" class="hidden" width="24" height="24"></iconify-icon>
            </button>
          </div>
        </div>
      </div>

      <!-- Mobile menu (hidden by default) - overlay style -->
      <div id="mobile-menu" class="hidden md:hidden absolute right-0 top-16 w-48 bg-white dark:bg-gray-800 shadow-lg rounded-bl-lg border border-gray-200 dark:border-gray-700 z-50">
        <div class="py-2 space-y-1">
          <a href="/" class="block text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-base font-medium">
            Home
          </a>
          <a href="/study" class="block text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-base font-medium">
            Study
          </a>
          <a href="/progress" class="block text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-base font-medium">
            Progress
          </a>
          {% if nav.has_grammar_access %}
          <a href="/exercises" class="block text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-base font-medium">
            Exercises
          </a>
          {% endif %}
          <!-- Reference link/expandable - show expandable menu if user has grammar access -->
          {% if nav.has_grammar_access %}
          <details class="reference-mobile-section group">
            <summary class="flex items-center justify-between text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-base font-medium cursor-pointer list-none">
              <span>Reference</span>
              <iconify-icon icon="heroicons:chevron-down" width="16" height="16" class="transition-transform duration-200 group-open:rotate-180"></iconify-icon>
            </summary>
            <div class="pl-4 space-y-1">
              <a href="/reference/basics" class="block text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-sm">
                Hangul Basics
              </a>
              <a href="/reference/pack/krnb_htsk_voc1_pack" class="block text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-sm">
                Grammar Lessons
              </a>
            </div>
          </details>
          {% else %}
          <a href="/reference" class="block text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-base font-medium">
            Reference
          </a>
          {% endif %}
          <a href="/pronunciation" id="nav-pronunciation-mobile" class="hidden block text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-base font-medium">
            Pronunciation
          </a>
          <a href="/listen" id="nav-listen-mobile" class="hidden block text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-base font-medium">
            Listen
          </a>
          <!-- Library link/expandable - show expandable menu if user has vocab access -->
          {% if nav.has_vocab_access %}
          <details class="library-mobile-section group">
            <summary class="flex items-center justify-between text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-base font-medium cursor-pointer list-none">
              <span>Library</span>
              <iconify-icon icon="heroicons:chevron-down" width="16" height="16" class="transition-transform duration-200 group-open:rotate-180"></iconify-icon>
            </summary>
            <div class="pl-4 space-y-1">
              <a href="/library/characters" class="block text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-sm">
                Characters
              </a>
              <a href="/library/vocabulary" class="block text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-sm">
                Vocabulary
              </a>
            </div>
          </details>
          {% else %}
          <a href="/library" class="block text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-base font-medium">
            Library
          </a>
          {% endif %}
          <a href="/guide" class="block text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-base font-medium">
            Guide
          </a>
          <a href="/settings" class="block text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-base font-medium">
            Settings
          </a>
          <div class="border-t border-gray-200 dark:border-gray-700 pt-2 mt-2">
            <span id="nav-username-mobile" class="block text-gray-500 dark:text-gray-400 text-sm px-3 py-1"></span>
            <form action="/logout" method="POST">
              <button type="submit" class="block w-full text-left text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-base font-medium">
                Logout
              </button>
            </form>
          </div>
        </div>
      </div>
    </nav>

    <main class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
      {% block content %}{% endblock %}
    </main>
  </div>

  <script>
    // Mobile menu toggle
    function toggleMobileMenu(event) {
      if (event) event.stopPropagation();
      const menu = document.getElementById('mobile-menu');
      const iconClosed = document.getElementById('menu-icon-closed');
      const iconOpen = document.getElementById('menu-icon-open');

      menu.classList.toggle('hidden');
      iconClosed.classList.toggle('hidden');
      iconOpen.classList.toggle('hidden');
    }

    function closeMobileMenu() {
      const menu = document.getElementById('mobile-menu');
      const iconClosed = document.getElementById('menu-icon-closed');
      const iconOpen = document.getElementById('menu-icon-open');

      if (!menu.classList.contains('hidden')) {
        menu.classList.add('hidden');
        iconClosed.classList.remove('hidden');
        iconOpen.classList.add('hidden');
        // Reset submenu state (close any open details elements)
        const libraryDetails = menu.querySelector('details.library-mobile-section');
        if (libraryDetails) libraryDetails.removeAttribute('open');
        const referenceDetails = menu.querySelector('details.reference-mobile-section');
        if (referenceDetails) referenceDetails.removeAttribute('open');
      }
    }

    // Close menu when clicking outside
    document.addEventListener('click', function(event) {
      const menu = document.getElementById('mobile-menu');
      const menuButton = event.target.closest('button[onclick*="toggleMobileMenu"]');
      if (!menu.contains(event.target) && !menuButton) {
        closeMobileMenu();
      }
    });

    // Display username from cookie (similar pattern to dark mode with localStorage)
    (function() {
      function getCookie(name) {
        const value = '; ' + document.cookie;
        const parts = value.split('; ' + name + '=');
        if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
        return null;
      }

      const username = getCookie('kr_username');
      if (username) {
        const navUsername = document.getElementById('nav-username');
        const navUsernameMobile = document.getElementById('nav-username-mobile');
        if (navUsername) navUsername.textContent = username;
        if (navUsernameMobile) navUsernameMobile.textContent = username;
      }
    })();

    // Check if pronunciation content exists and show/hide nav links
    (function() {
      fetch('/audio/scraped/htsk/lesson1/manifest.json', { method: 'HEAD' })
        .then(function(response) {
          if (response.ok) {
            var navLink = document.getElementById('nav-pronunciation');
            var navLinkMobile = document.getElementById('nav-pronunciation-mobile');
            var navListen = document.getElementById('nav-listen');
            var navListenMobile = document.getElementById('nav-listen-mobile');
            if (navLink) navLink.classList.remove('hidden');
            if (navLinkMobile) navLinkMobile.classList.remove('hidden');
            if (navListen) navListen.classList.remove('hidden');
            if (navListenMobile) navListenMobile.classList.remove('hidden');
          }
        })
        .catch(function() {
          // Content not available, keep links hidden
        });
    })();
  </script>

  <!-- Baby Haetae Mascot (hidden on small screens, smaller on medium) -->
  {% block mascot %}
  <div class="haetae-component hidden sm:block fixed bottom-4 right-4 sm:scale-75 md:scale-100 origin-bottom-right"
       data-bubble-position="left" data-show-tooltip="true" style="width: 80px; height: 80px;">
    {% include "partials/haetae_component.html" %}
  </div>
  {% endblock mascot %}

  <script>
    // Haetae Component System - handles all .haetae-component instances
    window.HaetaeSystem = (function() {
      const fireworkColors = [
        '#C1403D', '#2E8B8B', '#E5C158', '#3D5A80', '#81B29A', '#F4A261'
      ];
      const path = window.location.pathname;

      function initComponent(component) {
        const mascot = component.querySelector('.haetae-mascot');
        const fireworksContainer = component.querySelector('.haetae-fireworks');
        const bubbleContainer = component.querySelector('.haetae-speech-bubble');
        const bookAccessory = component.querySelector('.haetae-accessory-book');
        const capAccessory = component.querySelector('.haetae-accessory-cap');
        const bubblePosition = component.dataset.bubblePosition || 'right';
        const showTooltip = component.dataset.showTooltip === 'true';

        if (!mascot) return;

        // Ensure component is positioned for absolute children
        if (getComputedStyle(component).position === 'static') {
          component.style.position = 'relative';
        }

        // Show tooltip if enabled
        if (showTooltip) {
          const tooltip = document.createElement('div');
          tooltip.className = 'haetae-tooltip';
          tooltip.textContent = 'Your guardian companion on the path to mastery';
          component.appendChild(tooltip);
        }

        // Show page-specific accessories
        if (path.startsWith('/library') || path.startsWith('/reference')) {
          if (bookAccessory) bookAccessory.classList.remove('hidden');
        } else if (path.startsWith('/study') || path.startsWith('/practice') || path.startsWith('/listen')) {
          if (capAccessory) capAccessory.classList.remove('hidden');
        }

        // Fireworks function
        function createFirework() {
          if (!fireworksContainer) return;
          const centerX = component.offsetWidth / 2;
          const centerY = component.offsetHeight / 2;

          for (let i = 0; i < 12; i++) {
            const particle = document.createElement('div');
            particle.className = 'firework-particle';
            const angle = (i / 12) * Math.PI * 2;
            const distance = 40 + Math.random() * 30;
            const color = fireworkColors[Math.floor(Math.random() * fireworkColors.length)];

            particle.style.cssText = `
              left: ${centerX}px; top: ${centerY}px;
              background: ${color};
              --tx: ${Math.cos(angle) * distance}px;
              --ty: ${Math.sin(angle) * distance}px;
              animation-delay: ${Math.random() * 0.1}s;
            `;
            fireworksContainer.appendChild(particle);
            setTimeout(() => particle.remove(), 900);
          }

          for (let i = 0; i < 6; i++) {
            const star = document.createElement('div');
            const angle = Math.random() * Math.PI * 2;
            const distance = 20 + Math.random() * 50;
            star.className = 'firework-particle';
            star.style.cssText = `
              left: ${centerX}px; top: ${centerY}px;
              width: 4px; height: 4px;
              background: #FFFFFF; box-shadow: 0 0 4px #FFFFFF;
              --tx: ${Math.cos(angle) * distance}px;
              --ty: ${Math.sin(angle) * distance}px;
              animation-delay: ${0.1 + Math.random() * 0.2}s;
            `;
            fireworksContainer.appendChild(star);
            setTimeout(() => star.remove(), 1000);
          }
        }

        // Click interaction
        let revertTimeout = null;
        mascot.addEventListener('click', function() {
          const wasHappy = this.classList.contains('happy');
          if (revertTimeout) { clearTimeout(revertTimeout); revertTimeout = null; }
          this.classList.toggle('happy');

          if (!wasHappy) {
            createFirework();
            setTimeout(createFirework, 150);
            revertTimeout = setTimeout(() => {
              this.classList.remove('happy');
              revertTimeout = null;
            }, 2000);
          }
        });

        // Return API for this component
        return {
          component,
          mascot,
          bubblePosition,
          showSpeechBubble: function(title, subtitle, duration) {
            if (!bubbleContainer) return;
            bubbleContainer.innerHTML = '';

            const isLeft = bubblePosition === 'left';
            const bubble = document.createElement('div');
            bubble.className = `absolute ${isLeft ? 'right-full mr-2' : 'left-full ml-2'} top-1/2 -translate-y-1/2 whitespace-nowrap z-50`;
            bubble.style.animation = 'fadeIn 0.3s ease-out';

            const pointerClass = isLeft
              ? 'left-full border-l-green-500 border-r-0 border-l-8'
              : 'right-full border-r-green-500 border-l-0 border-r-8';

            bubble.innerHTML = `
              <div class="relative bg-green-500 text-white px-4 py-2 rounded-xl shadow-lg">
                <div class="absolute ${pointerClass} top-1/2 -translate-y-1/2 w-0 h-0 border-t-8 border-b-8 border-transparent"></div>
                <div class="font-semibold">${title}</div>
                ${subtitle ? `<div class="text-sm text-green-100">${subtitle}</div>` : ''}
              </div>
            `;

            bubbleContainer.appendChild(bubble);
            mascot.classList.add('happy');

            setTimeout(() => {
              bubble.style.transition = 'opacity 0.5s ease-out';
              bubble.style.opacity = '0';
              setTimeout(() => {
                bubble.remove();
                mascot.classList.remove('happy');
              }, 500);
            }, duration || 4000);
          },
          makeHappy: function() { mascot.classList.add('happy'); },
          makeNeutral: function() { mascot.classList.remove('happy'); }
        };
      }

      // Initialize all components on page
      const components = [];
      document.querySelectorAll('.haetae-component').forEach(el => {
        const instance = initComponent(el);
        if (instance) components.push(instance);
      });

      return {
        components,
        getFirst: function() { return components[0]; },
        showSpeechBubble: function(title, subtitle, duration) {
          const first = this.getFirst();
          if (first) first.showSpeechBubble(title, subtitle, duration);
        }
      };
    })();
  </script>

  <script>
    // Coordinate card flip animation with htmx swaps
    (function() {
      // Before request: unflip card and fade out content
      document.body.addEventListener('htmx:beforeRequest', function(evt) {
        const cardInner = document.querySelector('#card-inner');
        if (!cardInner) return;

        // Unflip if flipped
        if (cardInner.classList.contains('flipped')) {
          cardInner.classList.remove('flipped');
        }
        // Fade out content during transition
        cardInner.classList.add('card-loading');
      });

      // After swap: ensure clean state and fade in
      document.body.addEventListener('htmx:afterSwap', function(evt) {
        const cardInner = document.querySelector('#card-inner');
        if (!cardInner) return;

        // Ensure fresh state
        requestAnimationFrame(function() {
          cardInner.classList.remove('card-loading');
          cardInner.classList.remove('flipped');
        });
      });
    })();
  </script>

  {% block testing_scripts %}{% endblock %}

  <script>
    // Offline-aware navigation
    // Dims menu items that aren't cached when offline
    (function() {
      var cachedPages = [];
      var isOffline = !navigator.onLine;

      // Pages that are always available offline (precached in SW install)
      // /study redirects to /offline-study when offline (handled by SW)
      var alwaysOffline = ['/offline', '/study', '/offline-study'];

      // Pages that get precached when visiting home
      var precachedPaths = [
        '/reference', '/reference/basics', '/reference/tier1',
        '/reference/tier2', '/reference/tier3', '/reference/tier4',
        '/library', '/library/characters', '/library/vocabulary',
        '/guide'
      ];

      function updateCachedPages() {
        if (window.ServiceWorkerAPI && typeof window.ServiceWorkerAPI.getCachedPages === 'function') {
          window.ServiceWorkerAPI.getCachedPages().then(function(pages) {
            cachedPages = pages || [];
            updateMenuState();
          }).catch(function() {
            cachedPages = [];
            updateMenuState();
          });
        } else {
          updateMenuState();
        }
      }

      function isPathCached(path) {
        // Always-offline pages
        if (alwaysOffline.includes(path)) return true;

        // Exact match in cached pages
        if (cachedPages.includes(path)) return true;

        // Check if any cached page starts with this path (for nested routes)
        return cachedPages.some(function(cached) {
          return cached.startsWith(path + '/') || path.startsWith(cached + '/');
        });
      }

      function updateMenuState() {
        isOffline = !navigator.onLine;
        var navLinks = document.querySelectorAll('nav a[href]');

        navLinks.forEach(function(link) {
          try {
            var url = new URL(link.href);
            var path = url.pathname;

            // Only process same-origin links
            if (url.origin !== window.location.origin) return;

            if (isOffline && !isPathCached(path)) {
              // Offline and not cached - disable the link
              link.classList.add('opacity-50', 'pointer-events-none', 'cursor-not-allowed');
              link.setAttribute('data-offline-disabled', 'true');
              link.setAttribute('aria-disabled', 'true');
            } else {
              // Online or cached - restore the link
              link.classList.remove('opacity-50', 'pointer-events-none', 'cursor-not-allowed');
              link.removeAttribute('data-offline-disabled');
              link.removeAttribute('aria-disabled');
            }
          } catch (e) {
            // Invalid URL, skip
          }
        });
      }

      // Listen for online/offline events
      window.addEventListener('online', function() {
        console.log('[Offline Nav] Back online');
        updateMenuState();
      });

      window.addEventListener('offline', function() {
        console.log('[Offline Nav] Gone offline');
        updateCachedPages();
      });

      // Backup click handler to prevent navigation on disabled links
      document.addEventListener('click', function(e) {
        var link = e.target.closest('a[data-offline-disabled]');
        if (link) {
          e.preventDefault();
          console.log('[Offline Nav] Blocked navigation to offline-disabled link:', link.href);
        }
      });

      // Update menu state after HTMX navigation
      document.body.addEventListener('htmx:afterSettle', function() {
        updateMenuState();
      });

      // Initial check after page load
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(updateCachedPages, 500);
        });
      } else {
        setTimeout(updateCachedPages, 500);
      }
    })();
  </script>

  <script>
    // Testing mode: Global handler for ")" keystroke to show mock tier unlock
    // Activated when window.TESTING_MODE is set by page templates
    (function() {
      document.addEventListener('keydown', function(e) {
        if (!window.TESTING_MODE) return;
        if (e.key !== ')') return;
        e.preventDefault();
        if (window.HaetaeSystem) {
          window.HaetaeSystem.showSpeechBubble('Tier 2 Unlocked!', 'Y-Vowels & Special Ieung', 4000);
        }
      });
    })();
  </script>
</body>
</html>
