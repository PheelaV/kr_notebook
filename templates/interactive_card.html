<div id="card-container" data-testid="card-container" class="text-center">
  <div class="mb-2 flex items-center justify-center gap-2">
    <span class="text-sm text-gray-500 dark:text-gray-400">Tier {{ tier }}</span>
  </div>

  <!-- Card Front Display -->
  <div class="mb-4 sm:mb-6 bg-white dark:bg-gray-800 shadow-lg rounded-xl p-6 sm:p-10">
    {% if is_reverse %}
    <!-- Reverse card: romanization/English -> Korean -->
    <div class="text-base sm:text-lg text-gray-500 dark:text-gray-400 mb-2">
      {% if is_vocabulary %}Which matches{% else %}Which letter sounds like{% endif %}
    </div>
    <div data-testid="card-front" class="text-5xl sm:text-7xl font-bold text-gray-900 dark:text-white mb-4">
      {{ front }}
    </div>
    {% else %}
    <!-- Forward card: Korean -> romanization -->
    <div data-testid="card-front" class="text-5xl sm:text-7xl font-bold text-gray-900 dark:text-white mb-4">
      {{ front }}
    </div>
    {% endif %}

    {% if !validated %}
    <!-- Answer Input Phase -->
    <div id="input-phase">
      {% if is_multiple_choice %}
      <!-- Multiple Choice Mode (for Korean answers) -->
      <form id="answer-form" hx-post="{% if is_tracked %}/validate-answer{% else %}/practice-validate{% endif %}" hx-target="#card-container" hx-swap="outerHTML"
            onsubmit="return CardInteractions.validateMultipleChoice()">
        <input type="hidden" name="card_id" value="{{ card_id }}">
        {% if is_tracked %}
        <input type="hidden" name="session_id" value="{{ session_id }}">
        <input type="hidden" name="hints_used" id="hints-used" value="{{ hints_used }}">
        {% else %}
        <input type="hidden" name="track_progress" value="{{ track_progress }}">
        {% endif %}
        <input type="hidden" name="input_method" value="multiple_choice">
        <input type="hidden" name="answer" id="answer-input" value="">

        {% include "partials/multiple_choice_grid.html" %}

        <button type="submit" id="submit-btn" data-testid="submit-answer" disabled
                class="w-full bg-indigo-500 hover:bg-indigo-600 disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-semibold py-3 px-4 rounded-lg transition-colors">
          Check <span class="text-xs opacity-75">(Enter)</span>
        </button>
      </form>
      {% else %}
      <!-- Text Input Mode (for romanization answers) -->
      <form id="answer-form" hx-post="{% if is_tracked %}/validate-answer{% else %}/practice-validate{% endif %}" hx-target="#card-container" hx-swap="outerHTML">
        <input type="hidden" name="card_id" value="{{ card_id }}">
        {% if is_tracked %}
        <input type="hidden" name="session_id" value="{{ session_id }}">
        <input type="hidden" name="hints_used" id="hints-used" value="{{ hints_used }}">
        {% else %}
        <input type="hidden" name="track_progress" value="{{ track_progress }}">
        {% endif %}
        <input type="hidden" name="input_method" value="text_input">

        <div class="mb-4">
          <input type="text"
                 name="answer"
                 id="answer-input"
                 data-testid="answer-input"
                 placeholder="Type your answer..."
                 autocomplete="off"
                 autofocus
                 class="w-full p-3 text-lg text-center border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:border-indigo-500 dark:focus:border-indigo-400 focus:outline-none bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
        </div>

        {% if is_tracked %}
        <!-- Study mode: Check and Hint buttons -->
        <div class="grid grid-cols-2 gap-3 mb-4">
          <button type="submit"
                  data-testid="submit-answer"
                  class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
            Check
          </button>
          <button type="button" id="hint-btn"
                  data-testid="hint-button"
                  onclick="CardInteractions.showHint()"
                  class="w-full bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold py-3 px-4 rounded-lg transition-colors">
            Hint <span class="text-xs opacity-75">(H)</span>
          </button>
        </div>
        {% else %}
        <!-- Practice mode: Just Check button -->
        <button type="submit"
                data-testid="submit-answer"
                class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
          Check
        </button>
        {% endif %}
      </form>

      {% if is_tracked %}
      <!-- Hint Display Area (study mode only) -->
      <div id="hint-area" data-testid="hint-area" class="hidden">
        <div class="p-3 bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-700 rounded-lg text-amber-800 dark:text-amber-200">
          <span id="hint-text"></span>
        </div>
      </div>

      <script>
        // Initialize hints for this card (js_escape for proper JavaScript string escaping)
        CardInteractions.initHints("{{ hint_1|js_escape }}", "{{ hint_2|js_escape }}", "{{ hint_final|js_escape }}", {{ hints_used }});
      </script>
      {% endif %}
      {% endif %}
    </div>
    {% endif %}

    {% if validated %}
    <!-- Result Phase -->
    <div id="result-phase" data-testid="result-phase">
      {% include "partials/card_result.html" %}

      {% if is_tracked %}
      <!-- Study mode: Get next card (review was already recorded on validation) -->
      <form id="next-card-form" hx-post="/next-card" hx-target="#card-container" hx-swap="outerHTML">
        <input type="hidden" name="card_id" value="{{ card_id }}">
        <input type="hidden" name="session_id" value="{{ session_id }}">
        <button type="submit"
                data-testid="next-card"
                class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors text-lg">
          Next Card <span class="text-sm opacity-75">(Enter)</span>
        </button>
      </form>
      {% else %}
      <!-- Practice mode: Back to Study and Next buttons -->
      <div class="flex gap-2 sm:gap-3">
        <a href="/study" class="flex-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-900 dark:text-white font-semibold py-3 px-4 rounded-lg transition-colors text-center">
          Back to Study
        </a>
        <form id="practice-next-form" hx-post="/practice-next?mode=interactive" hx-target="#card-container" hx-swap="outerHTML" class="flex-1">
          <input type="hidden" name="card_id" value="{{ card_id }}">
          <input type="hidden" name="track_progress" value="{{ track_progress }}">
          <button type="submit"
                  class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
            Next <span class="text-sm opacity-75">(Enter)</span>
          </button>
        </form>
      </div>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>

{% if is_tracked && is_htmx_partial %}
<!-- OOB swap for stats bar (updates after each card in study mode) -->
<div id="stats-bar" hx-swap-oob="true" class="mb-4 flex items-center justify-center gap-3 text-xs text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2">
  <span class="flex items-center gap-1" title="New cards available (never seen)">
    <span class="text-blue-500 dark:text-blue-400">&#9679;</span>
    New: {{ stats.new_available }}{% if stats.new_cards_limit > 0 %} ({{ stats.new_cards_today }}/{{ stats.new_cards_limit }} today){% endif %}
  </span>
  <span class="text-gray-300 dark:text-gray-600">|</span>
  <span class="flex items-center gap-1" title="Cards in learning steps (not yet graduated)">
    <span class="text-orange-500 dark:text-orange-400">&#9679;</span>
    Learning: {{ stats.learning_due }}
  </span>
  <span class="text-gray-300 dark:text-gray-600">|</span>
  <span class="flex items-center gap-1" title="Due reviews (graduated cards)">
    <span class="text-green-500 dark:text-green-400">&#9679;</span>
    Review: {{ stats.reviews_due }}
  </span>
</div>
{% endif %}
