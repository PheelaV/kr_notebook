{% extends "base.html" %}

{% block title %}Offline Study - Hangul Learn{% endblock %}

{% block content %}
<!-- Load offline-study.js (offline-detect.js and offline-storage.js are in base.html) -->
<script src="{{ "/static/js/offline-study.js"|asset_url }}"></script>
<div class="max-w-3xl mx-auto">
  <!-- Offline mode indicator -->
  <div class="mb-6 flex items-center justify-between">
    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Offline Study</h1>
    <div class="flex items-center gap-2">
      <div class="inline-flex items-center gap-1 px-2 py-1 bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-200 rounded-full text-xs">
        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 3l8.735 8.735m0 0a.374.374 0 11.53.53m-.53-.53l.53.53m0 0L21 21M14.652 9.348a3.75 3.75 0 010 5.304m2.121-7.425a6.75 6.75 0 010 9.546m2.121-11.667c3.808 3.807 3.808 9.98 0 13.788m-9.546-4.242a3.733 3.733 0 01-1.06-2.122m-1.061 4.243a6.75 6.75 0 01-1.625-6.929m-.496 9.05c-3.068-3.067-3.664-7.67-1.79-11.334" />
        </svg>
        <span>Offline</span>
      </div>
      <div id="pending-badge" class="hidden inline-flex items-center gap-1 px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 rounded-full text-xs">
        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" />
        </svg>
        <span id="pending-count">0</span> to sync
      </div>
    </div>
  </div>

  <!-- Loading state -->
  <div id="loading-state" class="text-center py-12">
    <svg class="w-10 h-10 mx-auto text-indigo-600 dark:text-indigo-400 animate-spin" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <p class="mt-4 text-gray-600 dark:text-gray-400">Loading offline study session...</p>
  </div>

  <!-- No session state -->
  <div id="no-session-state" class="hidden">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 text-center">
      <svg class="w-16 h-16 mx-auto text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.776c.112-.017.227-.026.344-.026h15.812c.117 0 .232.009.344.026m-16.5 0a2.25 2.25 0 00-1.883 2.542l.857 6a2.25 2.25 0 002.227 1.932H19.05a2.25 2.25 0 002.227-1.932l.857-6a2.25 2.25 0 00-1.883-2.542m-16.5 0V6A2.25 2.25 0 016 3.75h3.879a1.5 1.5 0 011.06.44l2.122 2.12a1.5 1.5 0 001.06.44H18A2.25 2.25 0 0120.25 9v.776" />
      </svg>
      <h2 class="text-xl font-bold mt-4 text-gray-900 dark:text-white">No Offline Session</h2>
      <p class="mt-2 text-gray-600 dark:text-gray-400">
        You haven't downloaded a study session yet. When you're back online, go to Settings and click "Download Session".
      </p>
      <a href="/" class="inline-flex items-center gap-2 mt-6 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
        </svg>
        Return Home
      </a>
    </div>
  </div>

  <!-- Session ready state -->
  <div id="session-ready-state" class="hidden">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
      <div class="text-center mb-6">
        <svg class="w-14 h-14 mx-auto text-indigo-600 dark:text-indigo-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.436 60.436 0 00-.491 6.347A48.627 48.627 0 0112 20.904a48.627 48.627 0 018.232-4.41 60.46 60.46 0 00-.491-6.347m-15.482 0a50.57 50.57 0 00-2.658-.813A59.905 59.905 0 0112 3.493a59.902 59.902 0 0110.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0112 13.489a50.702 50.702 0 017.74-3.342M6.75 15a.75.75 0 100-1.5.75.75 0 000 1.5zm0 0v-3.675A55.378 55.378 0 0112 8.443m-7.007 11.55A5.981 5.981 0 006.75 15.75v-1.5" />
        </svg>
        <h2 class="text-xl font-bold mt-3 text-gray-900 dark:text-white">Ready to Study</h2>
        <p class="mt-2 text-gray-600 dark:text-gray-400">
          <span id="session-card-count" class="font-semibold text-indigo-600 dark:text-indigo-400">0</span> cards available
        </p>
      </div>

      <!-- Stale session warning -->
      <div id="stale-warning" class="hidden mb-6 p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-yellow-600 dark:text-yellow-400 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
          </svg>
          <div>
            <p class="text-sm text-yellow-800 dark:text-yellow-200">
              This session is over 48 hours old. Card priorities may have changed. Consider downloading a fresh session when online.
            </p>
          </div>
        </div>
      </div>

      <button id="start-study-btn" class="w-full px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-semibold text-lg">
        Start Studying
      </button>
    </div>
  </div>

  <!-- Study active state -->
  <div id="study-active-state" class="hidden">
    <!-- Progress bar -->
    <div class="mb-4 flex items-center justify-between text-sm text-gray-600 dark:text-gray-400">
      <span id="progress-text">0 reviewed</span>
      <span id="reinforcement-badge" class="hidden px-2 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 rounded text-xs">
        Reinforcement
      </span>
    </div>

    <!-- Card container -->
    <div id="card-container" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 min-h-[300px]">
      <!-- Cards will be rendered here by offline-study.js -->
    </div>
  </div>

  <!-- Footer note -->
  <p class="mt-6 text-center text-sm text-gray-500 dark:text-gray-400">
    Your progress is saved locally and will sync when back online.
  </p>
</div>

<script>
  // Initialize offline study when page loads
  (async function() {
    const loadingState = document.getElementById('loading-state');
    const noSessionState = document.getElementById('no-session-state');
    const sessionReadyState = document.getElementById('session-ready-state');
    const studyActiveState = document.getElementById('study-active-state');
    const pendingBadge = document.getElementById('pending-badge');
    const pendingCount = document.getElementById('pending-count');

    // Helper to show a state
    function showState(state) {
      [loadingState, noSessionState, sessionReadyState, studyActiveState].forEach(function(el) {
        el.classList.add('hidden');
      });
      state.classList.remove('hidden');
    }

    // Update pending count display
    async function updatePendingDisplay() {
      try {
        const count = await window.OfflineStorage.getPendingCount();
        if (count > 0) {
          pendingBadge.classList.remove('hidden');
          pendingCount.textContent = count;
        } else {
          pendingBadge.classList.add('hidden');
        }
      } catch (e) {
        // Ignore errors
      }
    }

    // Listen for pending updates
    window.addEventListener('offline-pending-update', function(e) {
      const count = e.detail.count;
      if (count > 0) {
        pendingBadge.classList.remove('hidden');
        pendingCount.textContent = count;
      } else {
        pendingBadge.classList.add('hidden');
      }
    });

    try {
      // Debug: Check what modules are available
      console.log('[OfflineStudy Page] Checking modules...');
      console.log('  OfflineCapability:', typeof window.OfflineCapability);
      console.log('  OfflineStorage:', typeof window.OfflineStorage);
      console.log('  OfflineStudy:', typeof window.OfflineStudy);

      if (typeof window.OfflineStudy === 'undefined') {
        console.error('[OfflineStudy Page] OfflineStudy module not loaded!');
        showState(noSessionState);
        return;
      }

      // Initialize offline study system
      const ready = await window.OfflineStudy.init();

      if (!ready) {
        // No session available
        showState(noSessionState);
        return;
      }

      // Get session info
      const session = await window.OfflineStorage.getSession();
      const ageHours = await window.OfflineStorage.getSessionAgeHours();

      // Update session info display
      document.getElementById('session-card-count').textContent = session.cards.length;

      // Show stale warning if needed (session over 48 hours old)
      if (ageHours !== null && ageHours > 48) {
        document.getElementById('stale-warning').classList.remove('hidden');
      }

      // Update pending display
      await updatePendingDisplay();

      // Show ready state
      showState(sessionReadyState);

      // Start study button
      document.getElementById('start-study-btn').addEventListener('click', function() {
        showState(studyActiveState);
        window.OfflineStudy.start({
          cardContainer: document.getElementById('card-container'),
          progressText: document.getElementById('progress-text'),
          reinforcementBadge: document.getElementById('reinforcement-badge'),
          pendingCount: pendingCount
        });
      });

    } catch (error) {
      console.error('[OfflineStudy] Error:', error);
      showState(noSessionState);
    }
  })();
</script>
{% endblock %}
