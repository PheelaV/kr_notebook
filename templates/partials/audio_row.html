<div id="audio-row-{{ lesson_id }}-{{ row.romanization }}" class="p-3 bg-white dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
  <div class="flex flex-wrap items-center gap-2 sm:gap-3 mb-2">
    <!-- Row label -->
    <span class="w-12 text-center flex-shrink-0">
      <span class="text-xl font-bold text-gray-900 dark:text-white">{{ row.character }}</span>
      <span class="block text-xs text-gray-500">{{ row.romanization }}</span>
    </span>

    <!-- Play buttons -->
    <button onclick="playAudio('{{ lesson_id }}', 'rows/row_{{ row.romanization }}.mp3')"
            class="flex items-center gap-1 px-2 py-1 text-sm bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 rounded hover:bg-indigo-200"
            title="Play original source">
      <iconify-icon icon="heroicons:play-solid" width="16" height="16"></iconify-icon>
      Src
    </button>

    <button onclick="playSegmentsSequence('{{ lesson_id }}', {{ row.segments_json }})"
            class="flex items-center gap-1 px-2 py-1 text-sm bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded hover:bg-green-200"
            title="Play segments in sequence">
      <iconify-icon icon="heroicons:chevron-right" width="16" height="16"></iconify-icon>
      Seg ({{ row.available_count }}/{{ row.syllables.len() }})
    </button>

    <!-- Toggle params button -->
    <button onclick="toggleRowParams('{{ lesson_id }}-{{ row.romanization }}')"
            class="text-xs text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
      Params
    </button>

    {% if !status_message.is_empty() %}
    <span class="text-xs {% if status_success %}text-green-600 dark:text-green-400{% else %}text-red-600 dark:text-red-400{% endif %}">
      {{ status_message }}
    </span>
    {% endif %}
  </div>

  <!-- Per-row parameters (visible after re-segment) -->
  <div id="params-{{ lesson_id }}-{{ row.romanization }}" class="{% if !show_params %}hidden{% endif %} mt-2 p-2 bg-gray-50 dark:bg-gray-700/50 rounded">
    <form hx-post="/settings/segment-row"
          hx-target="#audio-row-{{ lesson_id }}-{{ row.romanization }}"
          hx-swap="outerHTML"
          hx-indicator="#spinner-{{ lesson_id }}-{{ row.romanization }}"
          class="flex flex-wrap items-center gap-2">
      <input type="hidden" name="lesson" value="{{ lesson_id }}">
      <input type="hidden" name="row" value="{{ row.romanization }}">

      <label class="text-xs text-gray-600 dark:text-gray-400">
        <span class="font-mono font-bold">s</span>
        <input type="number" name="min_silence" value="{{ row.params.min_silence }}"
               class="w-14 px-1 py-0.5 text-xs border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
      </label>

      <label class="text-xs text-gray-600 dark:text-gray-400">
        <span class="font-mono font-bold">t</span>
        <input type="number" name="threshold" value="{{ row.params.threshold }}"
               class="w-14 px-1 py-0.5 text-xs border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
      </label>

      <label class="text-xs text-gray-600 dark:text-gray-400">
        <span class="font-mono font-bold">P</span>
        <input type="number" name="padding" value="{{ row.params.padding }}"
               class="w-14 px-1 py-0.5 text-xs border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
      </label>

      <label class="text-xs text-gray-600 dark:text-gray-400">
        <span class="font-mono font-bold">skip</span>
        <input type="number" name="skip_first" value="{{ row.params.skip_first }}" min="0"
               class="w-10 px-1 py-0.5 text-xs border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
      </label>

      <button type="submit"
              class="px-2 py-0.5 text-xs bg-indigo-600 text-white rounded hover:bg-indigo-700">
        Re-segment
      </button>
      <span id="spinner-{{ lesson_id }}-{{ row.romanization }}" class="htmx-indicator text-xs text-gray-500">
        Segmenting...
      </span>
    </form>
  </div>

  <!-- Individual segment buttons with timestamps -->
  <div class="flex gap-1 flex-wrap mt-2">
    {% for syl in row.syllables %}
    <div class="inline-flex items-center gap-0.5">
      {% if syl.has_audio %}
      <button onclick="playAudio('{{ lesson_id }}', 'syllables/{{ syl.romanization }}.mp3')"
              class="px-1.5 py-0.5 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-l hover:bg-gray-200 dark:hover:bg-gray-600"
              title="Play {{ syl.romanization }}">
        {{ syl.romanization }} ({{ syl.korean }})
      </button>
      {% if syl.manual_start_ms.is_some() %}
      {# Manual timestamps set - show in amber with start-end #}
      <button onclick="toggleSyllableEdit('{{ lesson_id }}', '{{ syl.romanization }}')"
              class="px-1 py-0.5 text-xs bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 rounded-r hover:bg-amber-200 dark:hover:bg-amber-800/50"
              title="Manual: {{ syl.manual_start_ms.unwrap() }}-{{ syl.manual_end_ms.unwrap() }}ms{% if syl.baseline_start_ms.is_some() %} (baseline: {{ syl.baseline_start_ms.unwrap() }}-{{ syl.baseline_end_ms.unwrap() }}){% endif %}">
        {{ syl.manual_start_ms.unwrap() }}-{{ syl.manual_end_ms.unwrap() }}
      </button>
      {% else %}{% if syl.baseline_start_ms.is_some() %}
      {# Baseline only - show in gray with start-end #}
      <button onclick="toggleSyllableEdit('{{ lesson_id }}', '{{ syl.romanization }}')"
              class="px-1 py-0.5 text-xs bg-gray-50 dark:bg-gray-800 text-gray-400 dark:text-gray-500 rounded-r hover:bg-gray-200 dark:hover:bg-gray-600"
              title="Baseline: {{ syl.baseline_start_ms.unwrap() }}-{{ syl.baseline_end_ms.unwrap() }}ms">
        {{ syl.baseline_start_ms.unwrap() }}-{{ syl.baseline_end_ms.unwrap() }}
      </button>
      {% else %}
      {# No baseline, no manual - show + to add #}
      <button onclick="toggleSyllableEdit('{{ lesson_id }}', '{{ syl.romanization }}')"
              class="px-1 py-0.5 text-xs bg-red-50 dark:bg-red-900/20 text-red-400 dark:text-red-500 rounded-r hover:bg-red-100 dark:hover:bg-red-900/40"
              title="No timestamps - click to manually set">
        +
      </button>
      {% endif %}{% endif %}
      {% else %}
      {# No audio file exists #}
      <span class="px-1.5 py-0.5 text-xs bg-gray-50 dark:bg-gray-800 text-gray-400 dark:text-gray-600 rounded-l"
            title="No audio for {{ syl.romanization }}">
        {{ syl.romanization }} ({{ syl.korean }})
      </span>
      <button onclick="toggleSyllableEdit('{{ lesson_id }}', '{{ syl.romanization }}')"
              class="px-1 py-0.5 text-xs bg-red-50 dark:bg-red-900/20 text-red-400 dark:text-red-500 rounded-r hover:bg-red-100 dark:hover:bg-red-900/40"
              title="No audio - click to manually create from source">
        +
      </button>
      {% endif %}
    </div>
    {% endfor %}
  </div>

  <!-- Per-syllable timestamp edit forms (hidden by default) -->
  {% for syl in row.syllables %}
  <div id="edit-{{ lesson_id }}-{{ syl.romanization }}" class="hidden mt-2 p-2 {% if syl.baseline_start_ms.is_some() %}bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800{% else %}bg-amber-50 dark:bg-amber-900/20 border-amber-200 dark:border-amber-800{% endif %} rounded border">
    <form hx-post="/settings/segment-manual"
          hx-target="#audio-row-{{ lesson_id }}-{{ row.romanization }}"
          hx-swap="outerHTML"
          class="flex flex-wrap items-center gap-2 text-xs">
      <input type="hidden" name="lesson" value="{{ lesson_id }}">
      <input type="hidden" name="syllable" value="{{ syl.korean }}">
      <input type="hidden" name="romanization" value="{{ syl.romanization }}">
      <input type="hidden" name="row" value="{{ row.romanization }}">

      <span class="font-medium text-gray-700 dark:text-gray-300">{{ syl.romanization }}:</span>

      <label class="text-gray-600 dark:text-gray-400">
        Start
        <input type="number" name="start_ms"
               value="{% if syl.manual_start_ms.is_some() %}{{ syl.manual_start_ms.unwrap() }}{% else %}{% if syl.baseline_start_ms.is_some() %}{{ syl.baseline_start_ms.unwrap() }}{% else %}0{% endif %}{% endif %}"
               class="w-16 px-1 py-0.5 border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
      </label>

      <label class="text-gray-600 dark:text-gray-400">
        End
        <input type="number" name="end_ms"
               value="{% if syl.manual_end_ms.is_some() %}{{ syl.manual_end_ms.unwrap() }}{% else %}{% if syl.baseline_end_ms.is_some() %}{{ syl.baseline_end_ms.unwrap() }}{% else %}500{% endif %}{% endif %}"
               class="w-16 px-1 py-0.5 border rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
      </label>

      {% if syl.baseline_start_ms.is_some() %}
      <span class="text-gray-400">(baseline: {{ syl.baseline_start_ms.unwrap() }}-{{ syl.baseline_end_ms.unwrap() }})</span>
      {% else %}
      <span class="text-amber-500">(no baseline - enter timestamps from source audio)</span>
      {% endif %}

      <button type="submit" class="px-2 py-0.5 bg-blue-600 text-white rounded hover:bg-blue-700">
        Apply
      </button>

      {% if syl.manual_start_ms.is_some() && syl.baseline_start_ms.is_some() %}
      <button type="button"
              hx-post="/settings/segment-reset"
              hx-target="#audio-row-{{ lesson_id }}-{{ row.romanization }}"
              hx-swap="outerHTML"
              hx-vals='{"lesson": "{{ lesson_id }}", "syllable": "{{ syl.korean }}", "romanization": "{{ syl.romanization }}", "row": "{{ row.romanization }}"}'
              class="px-2 py-0.5 bg-gray-500 text-white rounded hover:bg-gray-600"
              title="Reset to baseline">
        âœ•
      </button>
      {% endif %}
    </form>
  </div>
  {% endfor %}
</div>
