{% extends "base.html" %}

{% block title %}Study - Hangul Learn{% endblock %}

{% block content %}
<div class="max-w-lg mx-auto" id="study-container">
  {% if study_filters.len() > 2 %}
  <!-- Study filter dropdown and focus mode toggle -->
  <div class="mb-4 flex flex-wrap items-center gap-2 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2">
    <div class="flex items-center gap-2 min-w-0 flex-1">
      <label for="study-filter" class="text-sm text-gray-600 dark:text-gray-400 font-medium shrink-0">Study:</label>
      <select id="study-filter"
              class="min-w-0 flex-1 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded px-2 py-1 text-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 truncate"
              onchange="updateStudyFilter(this.value)">
        {% for filter in study_filters %}
        <option value="{{ filter.id }}" {% if filter.is_selected %}selected{% endif %}>
          {%- if filter.is_lesson %}  ↳ {% endif %}{{ filter.label -}}
        </option>
        {% endfor %}
      </select>
    </div>
    <!-- Focus mode toggle with lightning icon, text, and switch -->
    <button type="button" id="focus-toggle" onclick="toggleFocusMode()" title="Focus Mode: Faster learning steps (1→5→15→30 min)"
            class="shrink-0 flex items-center gap-2 px-3 py-1.5 rounded-lg transition-all cursor-pointer
                   {% if focus_mode_active %}bg-purple-100 dark:bg-purple-900/30{% else %}bg-gray-100 dark:bg-gray-700{% endif %}
                   hover:bg-purple-200 dark:hover:bg-purple-900/50 hover:scale-[1.02]">
      <svg class="w-4 h-4 {% if focus_mode_active %}text-yellow-500{% else %}text-purple-500 dark:text-purple-400{% endif %}" fill="currentColor" viewBox="0 0 20 20">
        <path d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"/>
      </svg>
      <span class="text-sm font-medium {% if focus_mode_active %}text-purple-700 dark:text-purple-300{% else %}text-gray-600 dark:text-gray-400{% endif %}">Focus</span>
      <!-- Toggle switch -->
      <div class="relative w-8 h-4 rounded-full transition-colors {% if focus_mode_active %}bg-purple-500{% else %}bg-gray-300 dark:bg-gray-600{% endif %}">
        <div class="absolute top-0.5 w-3 h-3 rounded-full bg-white shadow transition-transform {% if focus_mode_active %}translate-x-4{% else %}translate-x-0.5{% endif %}"></div>
      </div>
    </button>
  </div>
  <script>
    function updateStudyFilter(value) {
      fetch('/study/filter', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'filter=' + encodeURIComponent(value)
      }).then(() => window.location.reload());
    }
    function toggleFocusMode() {
      const currentlyEnabled = {{ focus_mode_active }};
      fetch('/study/focus', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'enabled=' + (!currentlyEnabled)
      }).then(() => window.location.reload());
    }
  </script>
  {% endif %}

  <!-- Session stats bar -->
  {% include "partials/stats_bar.html" %}

  {% if has_card %}
  {% include "interactive_card.html" %}
  {% else %}
  {% include "no_cards.html" %}
  {% endif %}

  <!-- Last Card (collapsible, shown after first card is answered) -->
  <div id="last-card-section" class="hidden mt-4">
    <button type="button" onclick="toggleLastCard()" class="w-full text-left text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 flex items-center gap-2 py-2">
      <span id="last-card-chevron" class="transition-transform">&#9654;</span>
      <span>Show last card</span>
    </button>
    <div id="last-card-content" class="hidden bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 mt-1">
      <div class="text-center">
        <div id="last-card-front" class="text-2xl font-bold text-gray-900 dark:text-white mb-2"></div>
        <div class="text-gray-400 dark:text-gray-500 text-sm mb-2">&#8595;</div>
        <div id="last-card-answer" class="text-xl font-semibold text-indigo-600 dark:text-indigo-400 mb-1"></div>
        <div id="last-card-user-answer" class="hidden text-sm text-gray-500 dark:text-gray-400 mb-1">
          <span>You answered: </span><span class="text-red-500"></span>
        </div>
        <div id="last-card-description" class="text-sm text-gray-500 dark:text-gray-400"></div>
        <div id="last-card-result" class="mt-2 text-sm font-medium"></div>

        <!-- Override section (hidden initially) -->
        <div id="override-section" class="hidden mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
          <div class="mb-3">
            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">
              Your answer (edit if needed):
            </label>
            <input type="text" id="suggested-answer"
                   class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded
                          bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                          focus:outline-none focus:ring-1 focus:ring-indigo-500"
                   placeholder="What should be accepted?">
          </div>

          <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">How would you rate your answer?</p>
          <div class="flex flex-wrap justify-center gap-2">
            <button onclick="submitOverride(0)"
                    class="px-3 py-1.5 text-sm bg-red-100 hover:bg-red-200 dark:bg-red-900/30 dark:hover:bg-red-900/50 text-red-800 dark:text-red-300 rounded">
              Wrong
            </button>
            <button onclick="submitOverride(2)"
                    class="px-3 py-1.5 text-sm bg-yellow-100 hover:bg-yellow-200 dark:bg-yellow-900/30 dark:hover:bg-yellow-900/50 text-yellow-800 dark:text-yellow-300 rounded">
              Hard
            </button>
            <button onclick="submitOverride(4)"
                    class="px-3 py-1.5 text-sm bg-green-100 hover:bg-green-200 dark:bg-green-900/30 dark:hover:bg-green-900/50 text-green-800 dark:text-green-300 rounded">
              Correct
            </button>
            <button onclick="submitOverride(5)"
                    class="px-3 py-1.5 text-sm bg-blue-100 hover:bg-blue-200 dark:bg-blue-900/30 dark:hover:bg-blue-900/50 text-blue-800 dark:text-blue-300 rounded">
              Easy
            </button>
          </div>
        </div>

        <!-- Toggle button -->
        <button id="show-override-btn" onclick="showOverrideSection()"
                class="mt-3 text-xs text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 underline">
          Override ruling
        </button>
      </div>
    </div>
  </div>

  <!-- Practice Mode nav button -->
  <div class="mt-6">
    <a href="/practice" class="block w-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-900 dark:text-white font-semibold py-3 px-4 rounded-lg transition-colors text-center">
      Practice Mode
    </a>
  </div>
</div>

<script>
  {% if testing_mode %}
  // Enable testing mode for global keystroke handler
  window.TESTING_MODE = true;
  {% endif %}

  // Last card tracking
  window.lastCardData = null;

  function toggleLastCard() {
    const content = document.getElementById('last-card-content');
    const chevron = document.getElementById('last-card-chevron');
    if (content.classList.contains('hidden')) {
      content.classList.remove('hidden');
      chevron.style.transform = 'rotate(90deg)';
    } else {
      content.classList.add('hidden');
      chevron.style.transform = 'rotate(0deg)';
    }
  }

  function captureCurrentCard() {
    const container = document.getElementById('card-container');
    if (!container) return;

    const front = container.querySelector('[data-testid="card-front"]');
    const resultPhase = container.querySelector('#result-phase');

    if (front && resultPhase) {
      // Card has been answered, capture it using data attributes
      const answerEl = resultPhase.querySelector('[data-correct-answer]');
      const userAnswerEl = resultPhase.querySelector('[data-user-answer]');
      const descEl = resultPhase.querySelector('[data-description]');
      const resultEl = resultPhase.querySelector('[data-result]');

      const result = resultEl?.dataset.result || 'unknown';

      // Capture session_id from the form
      const sessionInput = container.querySelector('input[name="session_id"]');
      const sessionId = sessionInput ? sessionInput.value : '';

      window.lastCardData = {
        cardId: container.dataset.cardId,
        sessionId: sessionId,
        front: front.textContent.trim(),
        answer: answerEl ? answerEl.textContent.trim() : '',
        userAnswer: userAnswerEl ? userAnswerEl.textContent.trim() : '',
        description: descEl ? descEl.textContent.trim() : '',
        result: result,
        isCorrect: result === 'correct',
        isIncorrect: result === 'incorrect'
      };

      updateLastCardDisplay();
    }
  }

  function updateLastCardDisplay() {
    if (!window.lastCardData) return;

    const section = document.getElementById('last-card-section');
    const frontEl = document.getElementById('last-card-front');
    const answerEl = document.getElementById('last-card-answer');
    const userAnswerEl = document.getElementById('last-card-user-answer');
    const descEl = document.getElementById('last-card-description');
    const resultEl = document.getElementById('last-card-result');

    section.classList.remove('hidden');
    frontEl.textContent = window.lastCardData.front;
    answerEl.textContent = window.lastCardData.answer;
    descEl.textContent = window.lastCardData.description || '';

    // Show user's wrong answer if they got it wrong
    if (window.lastCardData.userAnswer) {
      userAnswerEl.classList.remove('hidden');
      userAnswerEl.querySelector('.text-red-500').textContent = window.lastCardData.userAnswer;
    } else {
      userAnswerEl.classList.add('hidden');
    }

    if (window.lastCardData.isCorrect) {
      resultEl.textContent = 'Correct';
      resultEl.className = 'mt-2 text-sm font-medium text-green-600 dark:text-green-400';
    } else if (window.lastCardData.isIncorrect) {
      resultEl.textContent = 'Incorrect';
      resultEl.className = 'mt-2 text-sm font-medium text-red-600 dark:text-red-400';
    } else {
      resultEl.textContent = '';
    }

    // Reset override section when new card is shown
    document.getElementById('override-section').classList.add('hidden');
    document.getElementById('show-override-btn').classList.remove('hidden');
  }

  function showOverrideSection() {
    document.getElementById('override-section').classList.remove('hidden');
    document.getElementById('show-override-btn').classList.add('hidden');

    // Prefill the suggestion input with user's original answer
    const input = document.getElementById('suggested-answer');
    if (window.lastCardData?.userAnswer) {
      input.value = window.lastCardData.userAnswer;
    }
  }

  async function submitOverride(quality) {
    if (!window.lastCardData?.cardId) {
      console.error('No card ID available for override');
      return;
    }

    const suggestedAnswer = document.getElementById('suggested-answer').value.trim();

    try {
      const params = new URLSearchParams({
        card_id: window.lastCardData.cardId,
        session_id: window.lastCardData.sessionId || '',
        quality: quality,
        suggested_answer: suggestedAnswer,
        card_front: window.lastCardData.front || '',
        expected_answer: window.lastCardData.answer || '',
        user_answer: window.lastCardData.userAnswer || '',
        original_result: window.lastCardData.result || 'unknown'
      });

      const response = await fetch('/override-ruling', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params.toString()
      });

      if (response.ok) {
        // Update UI to show override was recorded
        const section = document.getElementById('override-section');
        section.innerHTML = '<p class="text-sm text-green-600 dark:text-green-400">Rating updated! Suggestion recorded.</p>';

        // Update result display
        updateOverrideResultDisplay(quality);
      } else {
        console.error('Override failed:', response.status);
      }
    } catch (err) {
      console.error('Override failed:', err);
    }
  }

  function updateOverrideResultDisplay(quality) {
    const resultEl = document.getElementById('last-card-result');
    const labels = { 0: 'Wrong', 2: 'Hard', 4: 'Correct', 5: 'Easy' };
    const colors = {
      0: 'text-red-600 dark:text-red-400',
      2: 'text-yellow-600 dark:text-yellow-400',
      4: 'text-green-600 dark:text-green-400',
      5: 'text-blue-600 dark:text-blue-400'
    };
    resultEl.textContent = `${labels[quality]} (overridden)`;
    resultEl.className = `mt-2 text-sm font-medium ${colors[quality]}`;
  }

  // Capture card data before HTMX swaps it out
  document.body.addEventListener('htmx:beforeSwap', function(evt) {
    if (evt.detail.target && evt.detail.target.id === 'card-container') {
      captureCurrentCard();
    }
  });
</script>
{% endblock %}
