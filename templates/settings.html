{% extends "base.html" %}

{% block title %}Settings - Hangul Learn{% endblock %}

{% block content %}
<div class="lg:flex lg:gap-8">
  <!-- TOC Component -->
  {% include "partials/toc.html" %}

  <!-- Main Content -->
  <div class="flex-1 max-w-2xl">
  <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
    Settings
  </h1>

  <!-- Notification Area -->
  <div id="notifications" class="mb-4"></div>

  <!-- Dark Mode - uses localStorage (client-side) -->
  <section id="appearance" class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 mb-6 scroll-mt-16">
    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
      Appearance
    </h2>

    <label class="flex items-center cursor-pointer">
      <input type="checkbox" id="darkModeToggle"
             onclick="toggleDarkMode(); this.checked = isDarkMode();"
             class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 dark:focus:ring-indigo-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
      <span class="ml-3 text-gray-900 dark:text-gray-100">Dark Mode</span>
    </label>
    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 ml-8">
      Use dark theme for the interface (saved in browser)
    </p>
  </section>

  <!-- Learning Settings -->
  <form id="learning" method="POST" action="/settings" class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 mb-6 scroll-mt-16">
    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
      Learning
    </h2>

    <!-- Unlock All Tiers -->
    <div class="mb-6">
      <label class="flex items-center cursor-pointer">
        <input type="checkbox" name="all_tiers_unlocked" value="true" id="allTiersToggle"
               {% if all_tiers_unlocked %}checked{% endif %}
               onchange="toggleTierOptions()"
               class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 dark:focus:ring-indigo-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
        <span class="ml-3 text-gray-900 dark:text-gray-100">Unlock All Tiers</span>
      </label>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 ml-8">
        Access all characters immediately for accelerated learning. Your progress is preserved.
      </p>
    </div>

    <!-- Per-Tier Options (only visible when Unlock All Tiers is enabled) -->
    <div id="tierOptions" class="{% if !all_tiers_unlocked %}hidden{% endif %} ml-8 mb-6 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600">
      <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
        Select which tiers to include in study sessions:
      </p>
      <div class="space-y-3">
        <label class="flex items-center cursor-pointer">
          <input type="checkbox" name="tier_1" value="true"
                 {% if enabled_tiers.contains(&1) %}checked{% endif %}
                 class="w-4 h-4 text-green-600 rounded focus:ring-green-500 dark:focus:ring-green-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
          <span class="ml-3">
            <span class="bg-green-500 text-white text-xs font-bold px-2 py-0.5 rounded-full mr-2">1</span>
            <span class="text-gray-700 dark:text-gray-300">Basic Consonants & Vowels</span>
          </span>
        </label>
        <label class="flex items-center cursor-pointer">
          <input type="checkbox" name="tier_2" value="true"
                 {% if enabled_tiers.contains(&2) %}checked{% endif %}
                 class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
          <span class="ml-3">
            <span class="bg-blue-500 text-white text-xs font-bold px-2 py-0.5 rounded-full mr-2">2</span>
            <span class="text-gray-700 dark:text-gray-300">Y-Vowels & Special Ieung</span>
          </span>
        </label>
        <label class="flex items-center cursor-pointer">
          <input type="checkbox" name="tier_3" value="true"
                 {% if enabled_tiers.contains(&3) %}checked{% endif %}
                 class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500 dark:focus:ring-purple-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
          <span class="ml-3">
            <span class="bg-purple-500 text-white text-xs font-bold px-2 py-0.5 rounded-full mr-2">3</span>
            <span class="text-gray-700 dark:text-gray-300">Diphthongs & Combined Vowels</span>
          </span>
        </label>
        <label class="flex items-center cursor-pointer">
          <input type="checkbox" name="tier_4" value="true"
                 {% if enabled_tiers.contains(&4) %}checked{% endif %}
                 class="w-4 h-4 text-orange-600 rounded focus:ring-orange-500 dark:focus:ring-orange-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
          <span class="ml-3">
            <span class="bg-orange-500 text-white text-xs font-bold px-2 py-0.5 rounded-full mr-2">4</span>
            <span class="text-gray-700 dark:text-gray-300">Compound Vowels</span>
          </span>
        </label>
      </div>
      <p class="text-xs text-gray-500 dark:text-gray-400 mt-3">
        Uncheck tiers you want to skip for now. At least one tier must be enabled.
      </p>
    </div>

    <!-- Focus Mode -->
    <div class="mb-6">
      <label class="block text-gray-900 dark:text-gray-100 font-medium mb-2">
        Focus Mode
      </label>
      <select name="focus_tier"
              class="w-full sm:w-auto px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-600">
        <option value="none" {% if focus_tier.is_none() %}selected{% endif %}>
          All tiers (normal mode)
        </option>
        {% for t in 1..=max_unlocked_tier %}
        <option value="{{ t }}" {% match focus_tier %}{% when Some with (ft) %}{% if *ft == t %}selected{% endif %}{% when None %}{% endmatch %}>
          Focus on Tier {{ t }}
        </option>
        {% endfor %}
      </select>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
        {% if focus_tier.is_some() %}
        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 mr-2">
          Focus active
        </span>
        Only Tier {{ focus_tier.unwrap() }} cards will appear in /study.
        {% else %}
        Focus on a specific tier to master it before mixing with others.
        Automatically enabled when you unlock a new tier.
        {% endif %}
      </p>
    </div>

    <!-- Retention Target -->
    <div class="mb-6">
      <label class="block text-gray-900 dark:text-gray-100 font-medium mb-2">
        Retention Target
      </label>
      <select name="desired_retention"
              class="w-full sm:w-auto px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-600">
        <option value="80" {% if desired_retention == 80 %}selected{% endif %}>
          80% - Fastest progress, more forgetting
        </option>
        <option value="85" {% if desired_retention == 85 %}selected{% endif %}>
          85% - Faster progress, some forgetting
        </option>
        <option value="90" {% if desired_retention == 90 %}selected{% endif %}>
          90% - Balanced (recommended)
        </option>
        <option value="95" {% if desired_retention == 95 %}selected{% endif %}>
          95% - Best retention, slower progress
        </option>
      </select>
      <div class="mt-2 text-sm text-gray-500 dark:text-gray-400">
        <p>Controls how often you'll review cards:</p>
        <ul class="mt-1 ml-4 list-disc space-y-0.5">
          <li><strong>80%:</strong> ~0.6x intervals, fastest progression, ~20% forgotten per interval</li>
          <li><strong>85%:</strong> ~0.8x intervals, faster progression, ~15% forgotten per interval</li>
          <li><strong>90%:</strong> Standard intervals, balanced, ~10% forgotten per interval</li>
          <li><strong>95%:</strong> ~1.5x intervals, slower progression, ~5% forgotten per interval</li>
        </ul>
      </div>
    </div>

    <button type="submit"
            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
      Save Settings
    </button>
  </form>

  <!-- Study Tools -->
  <section id="study-tools" class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 mb-6 scroll-mt-16">
    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
      Study Tools
    </h2>

    <div class="mb-4">
      <form method="POST" action="/settings/make-all-due" class="inline">
        <button type="button" onclick="if(confirm('Make all cards due for review now? This will reset scheduling for cards not yet due.')) this.form.submit();"
                class="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
          Ready for Review
        </button>
      </form>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
        Skip ahead to make all cards due now. Useful for intensive study sessions.
      </p>
    </div>

    <!-- Advanced Section (Collapsible) -->
    <details class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
      <summary class="cursor-pointer text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
        Advanced options...
      </summary>
      <div class="mt-4 p-4 bg-amber-50 dark:bg-amber-900/20 rounded-lg border border-amber-200 dark:border-amber-800">
        <p class="text-sm text-amber-700 dark:text-amber-300 mb-3">
          <strong>Graduate Tier:</strong> Mark all cards in a tier as learned with 3-day review interval.
          Use only if you already know the material.
        </p>
        <div class="flex flex-wrap gap-2">
          {% for status in tier_graduation %}
          <div class="inline-flex gap-1">
            {% if status.is_fully_graduated %}
            <span class="px-3 py-1.5 text-sm bg-gray-400 text-white rounded cursor-not-allowed opacity-60">
              Tier {{ status.tier }} ✓
            </span>
            {% else %}
            <form method="POST" action="/settings/graduate-tier/{{ status.tier }}" class="inline">
              <button type="button" onclick="if(confirm('Graduate all Tier {{ status.tier }} cards? They will be scheduled for review in 3 days.')) this.form.submit();"
                      class="px-3 py-1.5 text-sm {% if status.tier == 1 %}bg-green-600 hover:bg-green-700{% else %}{% if status.tier == 2 %}bg-blue-600 hover:bg-blue-700{% else %}{% if status.tier == 3 %}bg-purple-600 hover:bg-purple-700{% else %}bg-orange-600 hover:bg-orange-700{% endif %}{% endif %}{% endif %} text-white rounded">
                Graduate Tier {{ status.tier }}
              </button>
            </form>
            {% endif %}
            {% if status.has_backup %}
            <form method="POST" action="/settings/restore-tier/{{ status.tier }}" class="inline">
              <button type="button" onclick="if(confirm('Restore Tier {{ status.tier }} to pre-graduation state?')) this.form.submit();"
                      class="px-2 py-1.5 text-sm bg-gray-500 text-white rounded hover:bg-gray-600" title="Undo graduation">
                ↩
              </button>
            </form>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
    </details>
  </section>

  <!-- Data Management -->
  <section id="data" class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 mb-6 scroll-mt-16">
    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
      Data Management
    </h2>

    <div class="space-y-4">
      <!-- Export -->
      <div>
        <a href="/settings/export"
           class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
          <iconify-icon icon="heroicons:arrow-down-tray" class="mr-2" width="16" height="16"></iconify-icon>
          Export Data
        </a>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
          Download your learning database as a backup. Keep this file safe!
        </p>
      </div>

      <!-- Import -->
      <div>
        <form method="POST" action="/settings/import" enctype="multipart/form-data" class="space-y-2">
          <div class="flex items-center gap-3">
            <label class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 cursor-pointer focus-within:ring-2 focus-within:ring-blue-500 focus-within:ring-offset-2 dark:focus-within:ring-offset-gray-800">
              <iconify-icon icon="heroicons:arrow-up-tray" class="mr-2" width="16" height="16"></iconify-icon>
              Import Data
              <input type="file" name="database" accept=".db" class="hidden" onchange="this.form.querySelector('[type=submit]').disabled=false; this.form.querySelector('.file-name').textContent = this.files[0]?.name || 'No file selected';">
            </label>
            <span class="file-name text-sm text-gray-500 dark:text-gray-400">No file selected</span>
          </div>
          <button type="submit" disabled
                  class="px-3 py-1.5 text-sm bg-gray-600 text-white rounded hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">
            Upload
          </button>
        </form>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
          Import a previously exported database. <span class="text-amber-600 dark:text-amber-400">Warning: This will replace all your current data!</span>
        </p>
      </div>
    </div>
  </section>

  {% if is_admin %}
  <!-- User Management (Admin Only) -->
  <section id="users" class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 mb-6 scroll-mt-16">
    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
      User Management
      <span class="ml-2 text-xs font-normal text-gray-500 dark:text-gray-400">(admin only)</span>
    </h2>

    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
      {{ users.len() }} registered users. Promote users to admin or manage their roles.
    </p>

    <!-- User Search -->
    <div class="mb-4">
      <input type="text" id="userSearchInput" placeholder="Search users..."
             oninput="filterUsers(this.value)"
             class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-600">
    </div>

    <div id="userList" class="space-y-2 max-h-64 overflow-y-auto">
      {% for user in users %}
      {% include "partials/settings_user_row.html" %}
      {% endfor %}
    </div>
  </section>

  <!-- User Groups (Admin Only) -->
  <section id="groups" class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 mb-6 scroll-mt-16">
    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
      User Groups
      <span class="ml-2 text-xs font-normal text-gray-500 dark:text-gray-400">(admin only)</span>
    </h2>

    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
      Create groups to manage pack access. Groups can be used to restrict which users can enable specific packs.
    </p>

    <!-- Create Group Form -->
    <form hx-post="/settings/group/create"
          hx-target="#groups-list"
          hx-swap="beforeend"
          hx-on::after-request="if(event.detail.successful) this.reset()"
          class="mb-4 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
      <div class="flex flex-col sm:flex-row gap-3">
        <input type="text" name="id" placeholder="Group ID (e.g., beta-testers)" required
               class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white flex-1">
        <input type="text" name="name" placeholder="Display Name" required
               class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white flex-1">
        <button type="submit" class="px-4 py-2 text-sm bg-green-600 text-white rounded hover:bg-green-700">
          Create Group
        </button>
      </div>
    </form>

    <!-- Existing Groups -->
    <div id="groups-list" class="space-y-3">
      {% for group in groups %}
      {% include "partials/settings_group_card.html" %}
      {% endfor %}
    </div>
    {% if groups.is_empty() %}
    <p id="no-groups-msg" class="text-sm text-gray-400 dark:text-gray-500 italic">No groups created yet.</p>
    {% endif %}
  </section>

  <!-- Guest Management (Admin Only) -->
  <section id="guests" class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 mb-6 scroll-mt-16">
    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
      Guest Management
      <span class="ml-2 text-xs font-normal text-gray-500 dark:text-gray-400">(admin only)</span>
    </h2>

    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
      Guest accounts automatically expire after 24 hours of inactivity.
    </p>

    <div class="flex flex-wrap gap-3">
      <form method="POST" action="/settings/cleanup-guests" class="inline">
        <button type="submit"
                class="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 text-sm">
          Clean Up Expired
        </button>
      </form>
      <form method="POST" action="/settings/delete-all-guests" class="inline">
        <button type="button" onclick="if(confirm('Delete ALL guest accounts? This cannot be undone.')) this.form.submit();"
                class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">
          Delete All Guests
        </button>
      </form>
    </div>
  </section>

  <!-- External Pack Paths (Admin Only) -->
  <section id="pack-paths" class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 mb-6 scroll-mt-16">
    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
      External Pack Paths
      <span class="ml-2 text-xs font-normal text-gray-500 dark:text-gray-400">(admin only)</span>
    </h2>

    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
      Register directories containing content packs from arbitrary filesystem paths.
    </p>

    <!-- Register Path Form -->
    <form hx-post="/settings/pack-paths/register"
          hx-target="#registered-paths-list"
          hx-swap="outerHTML"
          hx-on::after-request="if(event.detail.successful) this.reset()"
          class="mb-4 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
      <div class="flex flex-col gap-3">
        <div class="flex gap-2">
          <input type="text" name="path" id="path-input" placeholder="/path/to/packs" required
                 class="flex-1 px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-mono">
          <button type="button" onclick="openDirectoryBrowser()"
                  class="px-3 py-2 text-sm bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded hover:bg-gray-300 dark:hover:bg-gray-500">
            Browse...
          </button>
        </div>
        <div class="flex flex-col sm:flex-row gap-3">
          <input type="text" name="name" placeholder="Display name (optional)"
                 class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white flex-1">
          <button type="submit" class="px-4 py-2 text-sm bg-green-600 text-white rounded hover:bg-green-700">
            Register Path
          </button>
        </div>
      </div>
    </form>

    <!-- Directory Browser Modal -->
    <div id="directory-browser-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="fixed inset-0 bg-black/50" onclick="closeDirectoryBrowser()"></div>
        <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-lg w-full p-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Select Directory</h3>
            <button type="button" onclick="closeDirectoryBrowser()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
              <iconify-icon icon="heroicons:x-mark" width="24" height="24"></iconify-icon>
            </button>
          </div>
          <div id="directory-browser-content">
            <p class="text-sm text-gray-500 dark:text-gray-400">Loading...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Registered Paths List -->
    {% include "partials/settings_registered_paths.html" %}
  </section>
  {% endif %}

  <!-- Content Packs Section -->
  {% if !card_packs.is_empty() %}
  <section id="packs" class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 mb-6 scroll-mt-16">
    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
      Content Packs
    </h2>
    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
      Enable additional card packs to expand your learning content.
    </p>

    <div class="space-y-3">
      {% for pack in card_packs %}
      <div class="p-4 rounded-lg border {% if pack.is_enabled %}bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800{% else %}bg-gray-50 dark:bg-gray-700/50 border-gray-200 dark:border-gray-600{% endif %}">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
          <div>
            <div class="flex items-center gap-2">
              {% if pack.is_enabled %}
              <iconify-icon icon="heroicons:check-circle" class="text-green-600 dark:text-green-400 flex-shrink-0" width="20" height="20"></iconify-icon>
              {% else %}
              <iconify-icon icon="heroicons:plus-circle" class="text-gray-400" width="20" height="20"></iconify-icon>
              {% endif %}
              <span class="font-medium text-gray-900 dark:text-white">{{ pack.name }}</span>
              {% if let Some(version) = &pack.version %}
              <span class="text-xs text-gray-400">v{{ version }}</span>
              {% endif %}
              {% if pack.is_restricted %}
              <span class="text-xs px-2 py-0.5 rounded bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300">restricted</span>
              {% endif %}
            </div>
            {% if let Some(desc) = &pack.description %}
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 ml-7">{{ desc }}</p>
            {% endif %}
            {% if let Some(count) = pack.cards_count %}
            <p class="text-xs text-gray-400 mt-1 ml-7">{{ count }} cards</p>
            {% endif %}
          </div>
          <div class="flex gap-2 ml-7 sm:ml-0">
            {% if pack.is_baseline %}
            <span class="px-3 py-1.5 text-sm text-gray-500 dark:text-gray-400">
              Built-in
            </span>
            {% else if pack.is_enabled %}
            <form method="POST" action="/settings/pack/{{ pack.id }}/disable" class="inline">
              <button type="button" onclick="if(confirm('Disable {{ pack.name }}? Your progress will be kept.')) this.form.submit();"
                      class="px-3 py-1.5 text-sm bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded hover:bg-gray-300 dark:hover:bg-gray-500">
                Disable
              </button>
            </form>
            {% else %}
            <form method="POST" action="/settings/pack/{{ pack.id }}/enable" class="inline">
              <button type="submit"
                      class="px-3 py-1.5 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700">
                Enable
              </button>
            </form>
            {% endif %}
          </div>
        </div>
        {% if is_admin && !pack.is_baseline %}
        <!-- Pack Permissions (Admin) -->
        <details class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
          <summary class="text-sm text-indigo-600 dark:text-indigo-400 cursor-pointer hover:underline">
            Manage access
          </summary>
          {% include "partials/settings_pack_permissions.html" %}
        </details>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <!-- Pronunciation Audio Section -->
  <section id="audio" class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 mb-6 scroll-mt-16">
    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
      Pronunciation Audio
      {% if !is_admin %}
      <span class="ml-2 text-xs font-normal text-gray-500 dark:text-gray-400">(view only)</span>
      {% endif %}
    </h2>
    {% if is_admin %}
    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
      Download audio from howtostudykorean.com. Requires Python 3.8+ and uv.
    </p>
    {% else %}
    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
      Audio content status. Contact admin to download or manage audio files.
    </p>
    {% endif %}

    <!-- Lesson Cards with Audio Preview -->
    {% for lesson in lesson_audio %}
    <div class="mb-4 p-4 rounded-lg border bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
        <div class="flex items-center gap-2">
          <iconify-icon icon="heroicons:check" class="text-green-600 dark:text-green-400 flex-shrink-0" width="20" height="20"></iconify-icon>
          <span class="font-medium text-gray-900 dark:text-white">{{ lesson.lesson_name }}</span>
        </div>
        <div class="flex flex-wrap gap-2">
          {% if is_admin %}
          <button type="button" onclick="toggleLessonPreview('{{ lesson.lesson_id }}')"
                  class="px-3 py-1.5 text-sm text-indigo-600 dark:text-indigo-400 hover:underline">
            Preview
          </button>
          {% endif %}
          <a href="/pronunciation" class="px-3 py-1.5 text-sm text-indigo-600 dark:text-indigo-400 hover:underline">
            View
          </a>
          {% if is_admin %}
          <form method="POST" action="/settings/delete-scraped/{% if lesson.lesson_id == "lesson1" %}1{% else %}{% if lesson.lesson_id == "lesson2" %}2{% else %}3{% endif %}{% endif %}" class="inline">
            <button type="button" onclick="if(confirm('Delete {{ lesson.lesson_name }} audio?')) this.form.submit();"
                    class="px-3 py-1.5 text-sm bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded hover:bg-red-200 dark:hover:bg-red-900/50">
              Delete
            </button>
          </form>
          {% endif %}
        </div>
      </div>

      <!-- Expandable Audio Preview (admin only) -->
      {% if is_admin %}
      <div id="preview-{{ lesson.lesson_id }}" class="hidden mt-4 border-t border-green-200 dark:border-green-800 pt-4">
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
          Compare source audio with segments. Adjust parameters per row if needed.
        </p>

        <!-- Parameter Legend -->
        <details class="mb-3 text-xs text-gray-500 dark:text-gray-400">
          <summary class="cursor-pointer hover:text-gray-700 dark:hover:text-gray-300">Parameter legend</summary>
          <div class="mt-2 p-2 bg-gray-50 dark:bg-gray-700/50 rounded grid grid-cols-2 gap-x-4 gap-y-1">
            <div><span class="font-mono font-bold">s</span> = min silence (ms)</div>
            <div><span class="font-mono font-bold">t</span> = threshold (dBFS)</div>
            <div><span class="font-mono font-bold">P</span> = padding (ms)</div>
            <div><span class="font-mono font-bold">skip</span> = skip first N segments</div>
          </div>
        </details>

        <div class="space-y-3">
          {% for row in lesson.rows %}
          {% let lesson_id = lesson.lesson_id %}
          {% let show_params = false %}
          {% let status_message = String::new() %}
          {% let status_success = false %}
          {% include "partials/audio_row.html" %}
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
    {% endfor %}

    <!-- Lesson 1 if not downloaded -->
    {% if !has_lesson1 %}
    <div class="mb-4 p-4 rounded-lg border bg-gray-50 dark:bg-gray-700/50 border-gray-200 dark:border-gray-600">
      <div class="flex items-center justify-between">
        <div>
          <div class="flex items-center gap-2">
            <iconify-icon icon="heroicons:plus" class="text-gray-400" width="20" height="20"></iconify-icon>
            <span class="font-medium text-gray-900 dark:text-white">Lesson 1: Basic Consonants & Vowels</span>
          </div>
          <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 ml-7">
            9 consonants + 6 vowels
          </p>
        </div>
        {% if is_admin %}
        <form method="POST" action="/settings/scrape/1" class="inline">
          <button type="button" onclick="this.disabled=true; this.textContent='Downloading...'; this.form.submit();"
                  class="px-3 py-1.5 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700">
            Download
          </button>
        </form>
        {% else %}
        <span class="text-sm text-gray-400">Not available</span>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <!-- Lesson 2 if not downloaded -->
    {% if !has_lesson2 %}
    <div class="mb-4 p-4 rounded-lg border bg-gray-50 dark:bg-gray-700/50 border-gray-200 dark:border-gray-600">
      <div class="flex items-center justify-between">
        <div>
          <div class="flex items-center gap-2">
            <iconify-icon icon="heroicons:plus" class="text-gray-400" width="20" height="20"></iconify-icon>
            <span class="font-medium text-gray-900 dark:text-white">Lesson 2: Additional Consonants</span>
          </div>
          <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 ml-7">
            10 consonants: tense + aspirated
          </p>
        </div>
        {% if is_admin %}
        <form method="POST" action="/settings/scrape/2" class="inline">
          <button type="button" onclick="this.disabled=true; this.textContent='Downloading...'; this.form.submit();"
                  class="px-3 py-1.5 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700">
            Download
          </button>
        </form>
        {% else %}
        <span class="text-sm text-gray-400">Not available</span>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <!-- Lesson 3 if not downloaded -->
    {% if !has_lesson3 %}
    <div class="mb-4 p-4 rounded-lg border bg-gray-50 dark:bg-gray-700/50 border-gray-200 dark:border-gray-600">
      <div class="flex items-center justify-between">
        <div>
          <div class="flex items-center gap-2">
            <iconify-icon icon="heroicons:plus" class="text-gray-400" width="20" height="20"></iconify-icon>
            <span class="font-medium text-gray-900 dark:text-white">Lesson 3: Diphthongs & Combined Vowels</span>
          </div>
          <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 ml-7">
            11 vowels: combined + diphthongs
          </p>
        </div>
        {% if is_admin %}
        <form method="POST" action="/settings/scrape/3" class="inline">
          <button type="button" onclick="this.disabled=true; this.textContent='Downloading...'; this.form.submit();"
                  class="px-3 py-1.5 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700">
            Download
          </button>
        </form>
        {% else %}
        <span class="text-sm text-gray-400">Not available</span>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <!-- Bulk Actions (admin only) -->
    {% if is_admin %}
    <div class="flex flex-wrap gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
      {% if has_lesson1 || has_lesson2 || has_lesson3 %}
      <form method="POST" action="/settings/delete-scraped" class="inline">
        <button type="button" onclick="if(confirm('Delete ALL pronunciation audio?')) this.form.submit();"
                class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">
          Delete All
        </button>
      </form>
      {% endif %}

      {% if !has_lesson1 || !has_lesson2 || !has_lesson3 %}
      <form method="POST" action="/settings/scrape" class="inline">
        <button type="button" onclick="this.disabled=true; this.textContent='Downloading...'; this.form.submit();"
                class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm">
          Download All
        </button>
      </form>
      {% endif %}
    </div>

    <!-- Global Re-segment Section -->
    {% if has_lesson1 || has_lesson2 || has_lesson3 %}
    <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
      <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
        Re-segment all (resets to specified padding, ignores saved params)
      </p>
      <form hx-post="/settings/segment"
            hx-target="#segment-all-status"
            hx-swap="innerHTML"
            hx-indicator="#segment-all-spinner"
            class="flex items-center gap-3">
        <label class="text-sm text-gray-600 dark:text-gray-400">Padding (ms):</label>
        <input type="number" name="padding" value="75" min="0" max="200" step="5"
               class="w-20 px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
        <button type="submit"
                class="px-3 py-1.5 text-sm bg-gray-600 text-white rounded hover:bg-gray-700">
          Re-segment All
        </button>
        <span id="segment-all-spinner" class="htmx-indicator text-sm text-gray-500">Segmenting...</span>
        <span id="segment-all-status" class="text-sm"></span>
      </form>
    </div>
    {% endif %}
    {% endif %}
  </section>

  <!-- App Version -->
  <div class="text-center text-sm text-gray-400 dark:text-gray-500 pt-4">
    Hangul Learn v{{ version }}
  </div>

  </div><!-- end flex-1 max-w-2xl -->
</div><!-- end lg:flex -->

<script>
  // Initialize dark mode checkbox to match current state
  document.addEventListener('DOMContentLoaded', function() {
    const checkbox = document.getElementById('darkModeToggle');
    if (checkbox) {
      checkbox.checked = isDarkMode();
    }
  });

  // Toggle tier options visibility
  function toggleTierOptions() {
    const allTiersToggle = document.getElementById('allTiersToggle');
    const tierOptions = document.getElementById('tierOptions');
    if (tierOptions) {
      tierOptions.classList.toggle('hidden', !allTiersToggle.checked);
    }
  }

  // Filter users by search term
  function filterUsers(searchTerm) {
    const term = searchTerm.toLowerCase().trim();
    const rows = document.querySelectorAll('#userList .user-row');
    rows.forEach(row => {
      const username = row.getAttribute('data-username') || '';
      row.style.display = username.includes(term) ? '' : 'none';
    });
  }

  // Toggle lesson preview section
  function toggleLessonPreview(lessonId) {
    const section = document.getElementById('preview-' + lessonId);
    if (section) {
      section.classList.toggle('hidden');
    }
  }

  // Toggle row params section
  function toggleRowParams(rowId) {
    const section = document.getElementById('params-' + rowId);
    if (section) {
      section.classList.toggle('hidden');
    }
  }

  // Audio player for settings preview
  let settingsAudio = null;
  let segmentQueue = [];
  let currentSegmentIndex = 0;

  // Cache bust value - updated when rows are re-segmented via HTMX
  var audioCacheBust = Date.now();

  function playAudio(lesson, path) {
    stopAudio();
    settingsAudio = new Audio('/audio/scraped/htsk/' + lesson + '/' + path + '?v=' + audioCacheBust);
    settingsAudio.play().catch(function(err) {
      console.log('Audio playback failed:', err);
    });
  }

  function stopAudio() {
    if (settingsAudio) {
      settingsAudio.pause();
      settingsAudio.currentTime = 0;
    }
    segmentQueue = [];
    currentSegmentIndex = 0;
  }

  function playSegmentsSequence(lesson, segments) {
    stopAudio();
    if (!segments || segments.length === 0) return;

    segmentQueue = segments.map(seg => '/audio/scraped/htsk/' + lesson + '/syllables/' + seg + '.mp3?v=' + audioCacheBust);
    currentSegmentIndex = 0;
    playNextSegment();
  }

  function playNextSegment() {
    if (currentSegmentIndex >= segmentQueue.length) {
      segmentQueue = [];
      currentSegmentIndex = 0;
      return;
    }

    settingsAudio = new Audio(segmentQueue[currentSegmentIndex]);
    settingsAudio.onended = function() {
      currentSegmentIndex++;
      setTimeout(playNextSegment, 100);
    };
    settingsAudio.play().catch(function(err) {
      console.log('Segment playback failed:', err);
      currentSegmentIndex++;
      playNextSegment();
    });
  }

  // Toggle syllable edit form
  function toggleSyllableEdit(lesson, romanization) {
    const section = document.getElementById('edit-' + lesson + '-' + romanization);
    if (section) {
      section.classList.toggle('hidden');
    }
  }

  // Update cache bust after HTMX swaps (re-segmenting audio)
  document.body.addEventListener('htmx:afterSwap', function(evt) {
    audioCacheBust = Date.now();
  });

  // Directory browser modal
  function openDirectoryBrowser() {
    const modal = document.getElementById('directory-browser-modal');
    modal.classList.remove('hidden');
    // Load initial directory listing
    htmx.ajax('POST', '/settings/pack-paths/browse', {
      target: '#directory-browser-content',
      swap: 'outerHTML',
      values: { path: '' }
    });
  }

  function closeDirectoryBrowser() {
    const modal = document.getElementById('directory-browser-modal');
    modal.classList.add('hidden');
  }

  // Close modal on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeDirectoryBrowser();
    }
  });
</script>

{% include "partials/toc_script.html" %}
{% endblock %}
