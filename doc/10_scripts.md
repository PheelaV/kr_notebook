# Scripts Reference

Utility scripts in `./scripts/`. All scripts use `.rpi-deploy.conf` for remote defaults when applicable.

## Quick Reference

| Script | Purpose |
|--------|---------|
| `start.sh` | Start local Docker container |
| `stop.sh` | Stop local Docker container |
| `backup.sh` | Create versioned local backup |
| `restore.sh` | Restore from local backup |
| `sync-db.sh` | Sync databases between instances |
| `sync-audio.sh` | Sync scraped audio to remote |
| `rpi-setup.sh` | Configure cross-compilation |
| `rpi-deploy.sh` | Build and deploy to RPi |
| `rpi-discover.sh` | Detect RPi system info |
| `test.sh` | Run all test levels |
| `reset_pwd.py` | Reset user password |
| `generate_favicon.py` | Generate favicon bundle |

---

## Local Development

### start.sh / stop.sh

Docker container management:

```bash
./scripts/start.sh           # start container, tail logs
./scripts/start.sh --build   # rebuild image first
./scripts/stop.sh            # stop container
```

---

## Testing

### test.sh

Master test runner with multiple levels:

```bash
./scripts/test.sh              # Run all tests (default)
./scripts/test.sh unit         # Rust + Python unit tests (fast)
./scripts/test.sh integration  # Unit + integration tests
./scripts/test.sh e2e          # E2E only (Playwright)
```

Environment variables:
- `PRESERVE_TEST_ENV=1` - Keep test data after run
- `VERBOSE=1` - Show verbose output

See `doc/08_testing.md` for comprehensive testing guide.

---

## Backup & Restore

### backup.sh

Create timestamped backup of all databases:

```bash
./scripts/backup.sh              # backup to backups/YYYYMMDD_HHMMSS/
./scripts/backup.sh mybackup     # backup to backups/mybackup/
```

### restore.sh

Restore from a named backup:

```bash
./scripts/restore.sh             # list available backups
./scripts/restore.sh 20251231_120000
./scripts/restore.sh mybackup --force   # skip confirmation
```

---

## Remote Sync

All sync scripts read from `.rpi-deploy.conf` or prompt interactively.

### sync-db.sh

Sync databases between local and remote:

```bash
./scripts/sync-db.sh pull                 # pull all from remote (systemd)
./scripts/sync-db.sh push                 # push all to remote
./scripts/sync-db.sh pull --docker        # remote uses Docker
./scripts/sync-db.sh push --user filip    # single user only
./scripts/sync-db.sh pull --auth-only     # app.db only
./scripts/sync-db.sh push -n              # dry-run
./scripts/sync-db.sh pull --no-restart    # don't restart service
```

### sync-audio.sh

Sync scraped audio content:

```bash
./scripts/sync-audio.sh          # sync using config/prompts
./scripts/sync-audio.sh -n       # dry-run
./scripts/sync-audio.sh -d       # delete remote files not in local
./scripts/sync-audio.sh -v       # verbose
```

---

## RPi Cross-Compilation

### Setup (one-time)

```bash
# Install cross tool (requires Docker)
cargo install cross --git https://github.com/cross-rs/cross

# Run setup - prompts for SSH, paths, features
./scripts/rpi-setup.sh aarch64-unknown-linux-gnu
```

### Deploy

```bash
./scripts/rpi-deploy.sh              # build + backup + deploy + restart
./scripts/rpi-deploy.sh --no-build   # skip build
./scripts/rpi-deploy.sh --no-backup  # skip remote backup
./scripts/rpi-deploy.sh --debug      # debug build
```

### Rollback

If a deployment causes issues, rollback to the previous version:

```bash
./scripts/rpi-deploy.sh --rollback
```

Restores:
- Previous binary (`kr_notebook.old`)
- Previous static assets (`static.old/`)
- Database backup (from `backups/latest`)

### Discover (run on RPi)

```bash
ssh raspberry 'bash -s' < ./scripts/rpi-discover.sh
```

---

## Configuration

### .rpi-deploy.conf

Generated by `rpi-setup.sh`, gitignored. Used by deploy and sync scripts:

```bash
RPI_SSH="raspberry"           # SSH alias or user@host
RPI_INSTALL_DIR="~/kr_notebook"
RPI_SERVICE="kr_notebook"
TARGET="aarch64-unknown-linux-gnu"
USE_CROSS=true
BUILD_FEATURES=""
```

---

## RPi Systemd Service

One-time setup on the RPi:

```bash
sudo nano /etc/systemd/system/kr_notebook.service
```

```ini
[Unit]
Description=Korean Notebook
After=network.target

[Service]
Type=simple
User=your_user
WorkingDirectory=/home/your_user/kr_notebook
ExecStart=/home/your_user/kr_notebook/target/release/kr_notebook
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
```

```bash
sudo systemctl daemon-reload
sudo systemctl enable kr_notebook
sudo systemctl start kr_notebook
```

---

## Utilities

### reset_pwd.py

Reset a user's password using the same dual-layer hashing as the app:

```bash
uv run scripts/reset_pwd.py <username> <new_password>
uv run scripts/reset_pwd.py admin mysecretpassword
```

Uses: Client SHA-256 â†’ Server Argon2 (matches `src/auth/password.rs`)

### generate_favicon.py

Generate complete favicon bundle from code (no source image needed):

```bash
uv run scripts/generate_favicon.py
```

Creates in `static/`:
- `favicon.ico` (16x16, 32x32, 48x48)
- `favicon.svg`, `-16x16.png`, `-32x32.png`
- `apple-touch-icon.png` (180x180)
- `android-chrome-192x192.png`, `-512x512.png`
- `site.webmanifest`
